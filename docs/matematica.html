<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
<meta name="theme-color" content="#667eea"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="Matematica sul Divano 3ª"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="description" content="Gioco educativo di matematica per bambini - Addizioni, Sottrazioni, Moltiplicazioni e Divisioni"/>

<title>Matematica sul Divano 3ª by Maestro Alberto</title>

<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            font-family: 'Arial', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #98d8a8 0%, #a8e6a3 50%, #b8f5b8 100%);
            position: relative;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            color: white;
            text-align: center;
            padding: min(1.5vh, 12px) min(2vw, 15px);
            position: relative;
            flex-shrink: 0;
        }

        /* Bottone Home funzionante */
        .home-button {
            position: absolute;
            left: min(2vw, 15px);
            top: 50%;
            transform: translateY(-50%);
            width: clamp(35px, 6vw, 45px);
            height: clamp(35px, 6vw, 45px);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            font-size: clamp(1rem, 2.5vw, 1.3rem);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .home-button:hover {
            transform: translateY(-50%) translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .header::after {
            content: '📚';
            position: absolute;
            right: min(2vw, 15px);
            font-size: min(3.5vw, 1.5em);
        }

        h1 {
            font-size: min(5vw, 2em);
            margin-bottom: min(0.5vh, 5px);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: min(2.5vw, 1em);
            opacity: 0.9;
        }

        .game-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: min(4vh, 30px) min(4vw, 30px);
            overflow: hidden;
        }

        .menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(40vw, 200px), 1fr));
            gap: min(3vw, 20px);
            margin-bottom: min(4vh, 30px);
            flex-shrink: 0;
        }

        .menu-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: min(3vh, 20px) min(2vw, 15px);
            border-radius: min(2vw, 15px);
            font-size: min(3vw, 1.3em);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            min-height: min(8vh, 60px);
            position: relative;
        }

        .menu-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .menu-btn.sottrazione {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }

        .menu-btn.moltiplicazione {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
        }

        .menu-btn.divisione {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        /* Sottomenu moltiplicazioni e divisioni */
        .submenu {
            display: none;
            grid-template-columns: 1fr;
            gap: min(2vw, 15px);
            margin-top: min(2vh, 15px);
            padding: min(2vh, 15px);
            border-radius: min(2vw, 15px);
            border: 2px solid;
        }

        .submenu.active {
            display: grid;
        }

        .submenu.multiplication {
            background: rgba(155, 89, 182, 0.1);
            border-color: #9b59b6;
        }

        .submenu.division {
            background: rgba(231, 76, 60, 0.1);
            border-color: #e74c3c;
        }

        .submenu-btn {
            color: white;
            border: none;
            padding: min(2vh, 15px) min(2vw, 15px);
            border-radius: min(1.5vw, 12px);
            font-size: min(2.8vw, 1.1em);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            min-height: min(6vh, 45px);
        }

        .submenu-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .submenu-btn.multiplication {
            background: linear-gradient(45deg, #8e44ad, #7d3c98);
        }

        .submenu-btn.multiplication:hover {
            background: linear-gradient(45deg, #7d3c98, #6c3483);
        }

        .submenu-btn.multiplication.potenze {
            background: linear-gradient(45deg, #e67e22, #d35400);
        }

        .submenu-btn.multiplication.potenze:hover {
            background: linear-gradient(45deg, #d35400, #ba4a00);
        }

        .submenu-btn.division {
            background: linear-gradient(45deg, #c0392b, #a93226);
        }

        .submenu-btn.division:hover {
            background: linear-gradient(45deg, #a93226, #922b21);
        }

        .submenu-btn.division.potenze {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .submenu-btn.division.potenze:hover {
            background: linear-gradient(45deg, #e67e22, #d35400);
        }

        .back-arrow {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .menu-btn.expanded .back-arrow {
            opacity: 1;
        }

        .game-screen {
            display: none;
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .game-screen.hidden {
            display: none;
        }

        .game-screen.active {
            display: flex;
        }

        .level-info {
            background: #f8f9fa;
            padding: min(2vh, 15px);
            border-radius: min(1.5vw, 10px);
            margin-bottom: min(3vh, 20px);
            border-left: 5px solid #007bff;
            flex-shrink: 0;
        }

        .level-info h2 {
            font-size: min(4vw, 1.5em);
            margin-bottom: min(1vh, 8px);
        }

        .level-info p {
            font-size: min(3vw, 1.1em);
        }

        .question {
            font-size: min(8vw, 3em);
            margin: min(4vh, 30px) 0;
            color: #333;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .answer-section {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: min(2vw, 15px);
            margin: min(3vh, 20px) 0;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        .answer-input {
            font-size: min(5vw, 2em);
            padding: min(2vh, 15px) min(2vw, 15px);
            border: 3px solid #ddd;
            border-radius: min(1.5vw, 10px);
            text-align: center;
            width: min(25vw, 180px);
            max-width: 180px;
        }

        .answer-input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 10px rgba(0,123,255,0.3);
        }

        .answer-input.remainder {
            width: min(20vw, 120px);
            max-width: 120px;
            background: #fff9e6;
            border-color: #ffc107;
        }

        .answer-input.remainder:focus {
            border-color: #ff9800;
            box-shadow: 0 0 10px rgba(255,152,0,0.3);
        }

        .input-label {
            font-size: min(3vw, 1.1em);
            font-weight: bold;
            color: #333;
            margin-bottom: min(1vh, 5px);
            text-align: center;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: min(1vh, 8px);
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: min(2vh, 15px) min(4vw, 30px);
            border-radius: min(1.5vw, 10px);
            font-size: min(3vw, 1.2em);
            cursor: pointer;
            margin: min(1vh, 10px);
            transition: all 0.3s ease;
        }

        .btn:hover:not(:disabled) {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            opacity: 0.5;
        }

        .btn.back {
            background: #6c757d;
        }

        .btn.back:hover {
            background: #545b62;
        }

        .progress {
            background: #e9ecef;
            height: min(3vh, 20px);
            border-radius: min(1.5vh, 10px);
            margin: min(2vh, 15px) 0;
            overflow: hidden;
            flex-shrink: 0;
        }

        .progress-bar {
            background: linear-gradient(45deg, #28a745, #20c997);
            height: 100%;
            transition: width 0.5s ease;
            border-radius: min(1.5vh, 10px);
        }

        .feedback {
            margin: min(3vh, 20px) 0;
            padding: min(3vh, 20px);
            border-radius: min(1.5vw, 10px);
            font-size: min(3vw, 1.2em);
            font-weight: bold;
            flex-shrink: 0;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .trophy {
            font-size: min(12vw, 4em);
            margin: min(3vh, 20px) 0;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .level-complete {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            padding: min(4vh, 30px);
            border-radius: min(2vw, 15px);
            margin: min(3vh, 20px) 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: min(2vw, 15px);
            margin: min(3vh, 20px) 0;
            flex-shrink: 0;
        }

        .stat-item {
            background: #f8f9fa;
            padding: min(2vh, 15px);
            border-radius: min(1.5vw, 10px);
            text-align: center;
        }

        .stat-value {
            font-size: min(5vw, 2em);
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            font-size: min(2.5vw, 1em);
            margin-top: min(1vh, 5px);
        }

        .hidden {
            display: none !important;
        }

        .sound-toggle {
            position: absolute;
            top: 50%;
            right: min(2vw, 15px);
            transform: translateY(-50%);
            background: linear-gradient(135deg, #f39c12, #e67e22);
            border: none;
            border-radius: 50%;
            width: clamp(35px, 6vw, 45px);
            height: clamp(35px, 6vw, 45px);
            font-size: clamp(1rem, 2.5vw, 1.3rem);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sound-toggle:hover {
            transform: translateY(-50%) translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .emoji-decoration {
            font-size: min(5vw, 2em);
            margin: 0 min(1vw, 10px);
        }

        .buttons-container {
            display: flex;
            justify-content: center;
            gap: min(2vw, 15px);
            flex-wrap: wrap;
            margin-top: auto;
            padding-top: min(2vh, 15px);
        }

        .offline-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            z-index: 1000;
            display: none;
        }

        /* Responsive adjustments for very small screens */
        @media (max-height: 500px) {
            .header {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.5em;
                margin-bottom: 5px;
            }
            
            .subtitle {
                font-size: 0.9em;
            }
            
            .game-content {
                padding: 15px;
            }
            
            .question {
                font-size: 2em;
                margin: 15px 0;
            }
        }

        @media (max-width: 400px) {
            .stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .stat-item {
                padding: 8px;
            }
            
            .menu {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .home-button,
            .sound-toggle {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
        }

        @media (max-width: 300px) {
            .menu-btn {
                font-size: 0.9em;
                padding: 10px;
            }

            .answer-input {
                width: 80px;
            }
        }

        .stat-item.domanda {
            background: #e3f2fd;
            border-left: 5px solid #2196f3;
        }

        .stat-item.corrette {
            background: #e8f5e9;
            border-left: 5px solid #4caf50;
        }

        .stat-item.livello {
            background: #fff3e0;
            border-left: 5px solid #ff9800;
        }

</style>
</head>
<body>
<div class="offline-indicator" id="offline-indicator">📴 Modalità Offline</div>

<div class="container">
<div class="header">
<button class="home-button" onclick="goToMainApp()" title="Torna alla Home">🏠</button>
<button class="sound-toggle" id="sound-toggle" onclick="toggleSound()" title="Attiva/Disattiva Suoni">🔊</button>
<h1>Matematica sul Divano 3ª</h1>
<div class="subtitle">by Maestro Alberto</div>
</div>
<div class="game-content">
<!-- Menu principale -->
<div class="menu" id="main-menu">
<button class="menu-btn" onclick="startGame('addizioni')">
                    ➕ Addizioni
                </button>
<button class="menu-btn sottrazione" onclick="startGame('sottrazioni')">
                    ➖ Sottrazioni  
                </button>
                <button class="menu-btn moltiplicazione" id="multiplication-btn" onclick="toggleMultiplicationMenu()">
                    <span class="back-arrow">←</span>
                    ✖️ Moltiplicazioni
                </button>
                <!-- Sottomenu moltiplicazioni -->
                <div class="submenu multiplication" id="multiplication-submenu">
                    <button class="submenu-btn multiplication" onclick="startGame('tabelline')">
                        🎯 Tabelline (0-10)
                    </button>
                    <button class="submenu-btn multiplication potenze" onclick="startGame('moltiplicazioni_potenze')">
                        🚀 Moltiplicazioni x10, x100, x1000
                    </button>
                </div>
                <button class="menu-btn divisione" id="division-btn" onclick="toggleDivisionMenu()">
                    <span class="back-arrow">←</span>
                    ➗ Divisioni
                </button>
                <!-- Sottomenu divisioni -->
                <div class="submenu division" id="division-submenu">
                    <button class="submenu-btn division" onclick="startGame('divisioni')">
                        🎯 Divisioni Classiche (tabelline)
                    </button>
                    <button class="submenu-btn division potenze" onclick="startGame('divisioni_potenze')">
                        🚀 Divisioni ÷10, ÷100, ÷1000
                    </button>
                </div>
</div>

<!-- Schermo di gioco -->
<div class="game-screen" id="game-screen">
<div class="level-info">
<h2 id="game-title"></h2>
<p id="level-description"></p>
</div>
<div class="progress">
<div class="progress-bar" id="progress-bar" style="width: 0%"></div>
</div>
<div class="stats">
<div class="stat-item domanda">
<div class="stat-value" id="current-question">1</div>
<div class="stat-label">Domanda</div>
</div>
<div class="stat-item corrette">
<div class="stat-value" id="correct-answers">0</div>
<div class="stat-label">Corrette</div>
</div>
<div class="stat-item livello">
<div class="stat-value" id="current-level">1</div>
<div class="stat-label">Livello</div>
</div>
</div>
<div class="question" id="question"></div>
<div class="answer-section">
<div class="input-group">
<div class="input-label" id="quotient-label">Risultato</div>
<input class="answer-input" id="answer-input" placeholder="?" type="number"/>
</div>
<div class="input-group hidden" id="remainder-group">
<div class="input-label">Resto</div>
<input class="answer-input remainder" id="remainder-input" placeholder="?" type="number"/>
</div>
<button class="btn" id="confirm-btn" onclick="checkAnswer()">Conferma</button>
</div>
<div class="feedback hidden" id="feedback"></div>
<div class="buttons-container">
<button class="btn back" onclick="goHome()">🏠 Menu Principale</button>
</div>
</div>
<!-- Schermo completamento livello -->
<div class="game-screen" id="level-complete-screen">
<div class="level-complete">
<div class="trophy" id="trophy"></div>
<h2 id="completion-title"></h2>
<p id="completion-message"></p>
<div class="stats">
<div class="stat-item">
<div class="stat-value" id="final-correct" style="color: #4caf50;">0</div>
<div class="stat-label">Risposte Corrette</div>
</div>
<div class="stat-item">
<div class="stat-value" id="final-errors" style="color: #f44336;">0</div>
<div class="stat-label">Errori</div>
</div>
<div class="stat-item">
<div class="stat-value" id="completion-level" style="color: #ff9800;">1</div>
<div class="stat-label">Livello Completato</div>
</div>
</div>
</div>
<div class="buttons-container">
<button class="btn" id="continue-btn" onclick="continueGame()">Livello Successivo 🚀</button>
<button class="btn back" onclick="goHome()">🏠 Menu Principale</button>
</div>
</div>
</div>
</div>

<script>
        // ========================================
        // INTEGRAZIONE CON SISTEMA PWA UNIFICATO
        // ========================================
        
        // Controlla se l'app è installata usando il localStorage unificato
        function checkPWAInstallationStatus() {
            try {
                const isInstalled = localStorage.getItem('app-installed') === 'true';
                const installDate = localStorage.getItem('app-installed-date');
                
                if (isInstalled) {
                    console.log('🎉 PWA Installata dal:', installDate);
                    return true;
                }
            } catch (e) {
                console.log('⚠️ localStorage non disponibile');
            }
            return false;
        }

        // Offline/Online status sincronizzato
        function updateOnlineStatus() {
            const indicator = document.getElementById('offline-indicator');
            if (navigator.onLine) {
                indicator.style.display = 'none';
            } else {
                indicator.style.display = 'block';
            }
        }

        // Gestione navigazione - torna all'index quando si clicca su home
        function goToMainApp() {
            playClickSound();
            window.location.href = './index.html';
        }

        // ========================================
        // SISTEMA AUDIO WEB AUDIO API
        // ========================================
        
        let audioContext;
        let soundEnabled = true;

        // Inizializza il contesto audio
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // Crea un tono delicato
        function playTone(frequency, duration, volume = 0.1, type = 'sine') {
            if (!soundEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = type;
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        // Suoni specifici
        function playCorrectSound() {
            if (!soundEnabled) return;
            // Accordo maggiore delicato (Do-Mi-Sol)
            setTimeout(() => playTone(523.25, 0.3, 0.08), 0);    // Do
            setTimeout(() => playTone(659.25, 0.3, 0.06), 50);   // Mi
            setTimeout(() => playTone(783.99, 0.4, 0.05), 100);  // Sol
        }

        function playIncorrectSound() {
            if (!soundEnabled) return;
            // Nota singola soft e comprensiva
            playTone(220, 0.4, 0.06, 'triangle');
        }

        function playLevelCompleteSound() {
            if (!soundEnabled) return;
            // Sequenza melodica allegra ma delicata
            const notes = [523.25, 587.33, 659.25, 698.46, 783.99]; // Do-Re-Mi-Fa-Sol
            notes.forEach((freq, i) => {
                setTimeout(() => playTone(freq, 0.4, 0.07), i * 150);
            });
        }

        function playClickSound() {
            if (!soundEnabled) return;
            // Click molto soft
            playTone(800, 0.1, 0.03, 'triangle');
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const toggle = document.getElementById('sound-toggle');
            toggle.textContent = soundEnabled ? '🔊' : '🔇';
            toggle.title = soundEnabled ? 'Disattiva Suoni' : 'Attiva Suoni';
            
            if (soundEnabled) {
                initAudio();
                playClickSound(); // Test del suono
            }
        }

        // ========================================
        // GESTIONE SOTTOMENU
        // ========================================
        
        // Gestione sottomenu moltiplicazione
        let isMultiplicationMenuOpen = false;

        function toggleMultiplicationMenu() {
            playClickSound(); // Assicura il suono
            
            // Chiudi il menu divisioni se aperto
            if (isDivisionMenuOpen) {
                toggleDivisionMenu();
            }
            
            const submenu = document.getElementById('multiplication-submenu');
            const btn = document.getElementById('multiplication-btn');
            
            if (isMultiplicationMenuOpen) {
                // Chiudi il menu
                submenu.classList.remove('active');
                btn.classList.remove('expanded');
                isMultiplicationMenuOpen = false;
            } else {
                // Apri il menu
                submenu.classList.add('active');
                btn.classList.add('expanded');
                isMultiplicationMenuOpen = true;
            }
        }

        // Gestione sottomenu divisione
        let isDivisionMenuOpen = false;

        function toggleDivisionMenu() {
            playClickSound(); // Assicura il suono
            
            // Chiudi il menu moltiplicazioni se aperto
            if (isMultiplicationMenuOpen) {
                toggleMultiplicationMenu();
            }
            
            const submenu = document.getElementById('division-submenu');
            const btn = document.getElementById('division-btn');
            
            if (isDivisionMenuOpen) {
                // Chiudi il menu
                submenu.classList.remove('active');
                btn.classList.remove('expanded');
                isDivisionMenuOpen = false;
            } else {
                // Apri il menu
                submenu.classList.add('active');
                btn.classList.add('expanded');
                isDivisionMenuOpen = true;
            }
        }

        // ========================================
        // SISTEMA ANTI-RIPETIZIONE MIGLIORATO PER TABELLINE
        // ========================================
        
        let tabellineQuestions = [];
        let tabellineCurrentIndex = 0;
        
        // Funzione per mescolare un array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        // Inizializza le tabelline con sistema anti-ripetizione avanzato
        function initializeTabellineQuestions() {
            tabellineQuestions = [];
            
            // Genera TUTTE le possibili tabelline 0-10 (inclusi 3×5 e 5×3)
            for (let a = 0; a <= 10; a++) {
                for (let b = 0; b <= 10; b++) {
                    tabellineQuestions.push({
                        a: a,
                        b: b,
                        result: a * b,
                        operation: '×',
                        key: `${a}x${b}`
                    });
                }
            }
            
            // Mischia le domande
            shuffleArray(tabellineQuestions);
            tabellineCurrentIndex = 0;
            
            console.log(`🎯 Tabelline: ${tabellineQuestions.length} domande totali preparate e mescolate`);
        }
        
        // Genera tabelline senza ripetizioni immediate
        function generateMultiplicationAdvanced() {
            // Se abbiamo finito tutte le domande, rimescola e ricomincia
            if (tabellineCurrentIndex >= tabellineQuestions.length) {
                console.log('🔄 Tabelline: rimescolamento automatico dopo aver completato tutte le domande');
                shuffleArray(tabellineQuestions);
                tabellineCurrentIndex = 0;
            }
            
            const question = tabellineQuestions[tabellineCurrentIndex];
            tabellineCurrentIndex++;
            
            console.log(`🎯 Tabellina ${tabellineCurrentIndex}/${tabellineQuestions.length}: ${question.a} × ${question.b} = ${question.result}`);
            
            return {
                a: question.a,
                b: question.b,
                result: question.result,
                operation: '×'
            };
        }

        // ========================================
        // LOGICA DI GIOCO COMPLETA
        // ========================================
        
        // Variabili globali del gioco
        let currentGame = '';
        let currentLevel = 1;
        let currentQuestion = 1;
        let correctAnswers = 0;
        let totalErrors = 0;
        let questionsPerLevel = 10;
        let currentQuestionData = {};
        let usedQuestions = [];
        let gameUsedQuestions = new Set(); // Tutte le domande usate in tutto il gioco
        let onesTableUsed = false; // Per controllare 1 x qualsiasi numero

        // Configurazioni dei giochi
        const gameConfigs = {
            addizioni: {
                title: "Addizioni",
                levels: 4,
                questionsPerLevel: 10,
                descriptions: [
                    "Livello 1: Amici del 10",
                    "Livello 2: Addizioni entro e oltre la decina (max 20)", 
                    "Livello 3: Tappa alla decina successiva (es: 27+5=30+2)",
                    "Livello 4: Addizioni senza riporto (es: 23+45=68)"
                ]
            },
            sottrazioni: {
                title: "Sottrazioni",
                levels: 5,
                questionsPerLevel: 10,
                descriptions: [
                    "Livello 1: Amici del 10 (es: 10-3=7)",
                    "Livello 2: Unità - unità (es: 8-5=3)",
                    "Livello 3: Decine - unità (es: 30-7=23)",
                    "Livello 4: Tappa alla decina precedente (es: 31-3)",
                    "Livello 5: Sottrazioni senza prestito (es: 65-23=42)"
                ]
            },
            tabelline: {
                title: "Tabelline",
                levels: 10,
                questionsPerLevel: 10,
                descriptions: [
                    "Livello 1: 10 tabelline casuali (0-10)",
                    "Livello 2: 10 tabelline casuali (0-10)", 
                    "Livello 3: 10 tabelline casuali (0-10)",
                    "Livello 4: 10 tabelline casuali (0-10)",
                    "Livello 5: 10 tabelline casuali (0-10)",
                    "Livello 6: 10 tabelline casuali (0-10)",
                    "Livello 7: 10 tabelline casuali (0-10)",
                    "Livello 8: 10 tabelline casuali (0-10)",
                    "Livello 9: 10 tabelline casuali (0-10)",
                    "Livello 10: 10 tabelline casuali (0-10)"
                ]
            },
            moltiplicazioni_potenze: {
                title: "Moltiplicazioni per 10, 100, 1000",
                levels: 5,
                questionsPerLevel: 10,
                descriptions: [
                    "Completa correttamente e leggi il numero ad alta voce",
                    "Completa correttamente e leggi il numero ad alta voce", 
                    "Completa correttamente e leggi il numero ad alta voce",
                    "Completa correttamente e leggi il numero ad alta voce",
                    "Completa correttamente e leggi il numero ad alta voce"
                ]
            },
            divisioni: {
                title: "Divisioni",
                levels: 2,
                questionsPerLevel: 15,
                descriptions: [
                    "Usa le tabelline e risolvi le divisioni",
                    "Trova il quoziente usando le tabelline e scrivi anche il resto"
                ]
            },
            divisioni_potenze: {
                title: "Divisioni per 10, 100, 1000",
                levels: 7,
                questionsPerLevel: 10,
                descriptions: [
                    "Dividi per 10",
                    "Dividi per 10 numeri con unità di migliaia e leggi il numero", 
                    "Dividi per 100",
                    "Dividi per 100 numeri più grandi",
                    "Dividi per 1000",
                    "Divisioni miste: ÷10, ÷100, ÷1000 - Stai attento al divisore!",
                    "Divisioni miste avanzate: ÷10, ÷100, ÷1000 - Sfida finale!"
                ]
            }
        };

        // Messaggi di incoraggiamento
        const encouragementMessages = [
            "Non mollare! Puoi farcela! 💪",
            "Riprova, sei quasi arrivato! 🌟",
            "Forza! Il prossimo livello ti aspetta! 🚀",
            "Continua così, stai migliorando! ⭐",
            "Non arrenderti, sei bravissimo! 🎯"
        ];

        const successMessages = [
            "Fantastico! Sei un campione! 🏆",
            "Bravissimo! Hai superato il livello! 🎉",
            "Eccezionale! Continua così! ⭐",
            "Perfetto! Sei davvero bravo! 🌟",
            "Magnifico! Vai al prossimo livello! 🚀"
        ];

        // ========================================
        // GENERATORI DI DOMANDE SENZA RIPETIZIONI
        // ========================================
        
        function generateAddition(level) {
            let a, b, attempts = 0;
            const maxAttempts = 100;
            
            do {
                switch(level) {
                    case 1: // Amici del 10
                        a = Math.floor(Math.random() * 9) + 1;
                        b = 10 - a;
                        break;
                    case 2: // Entro e oltre la decina (max 20)
                        a = Math.floor(Math.random() * 9) + 1;
                        b = Math.floor(Math.random() * 9) + 1;
                        // Assicura che non superi 20
                        if (a + b > 20) {
                            b = 20 - a;
                        }
                        break;
                    case 3: // Tappa alla decina successiva - CORRETTO
                        // Il primo numero deve avere unità (non decine piene)
                        a = Math.floor(Math.random() * 80) + 11; // Da 11 a 90
                        // Assicura che a non finisca per 0
                        if (a % 10 === 0) {
                            a = a - Math.floor(Math.random() * 9) - 1; // Sottrai 1-9
                        }
                        
                        const unitsOfA = a % 10;
                        // b deve essere compreso tra 1 e 9 (EVITA +10)
                        // e deve superare le unità di a per fare tappa
                        const minB = Math.max(1, 11 - unitsOfA); // Almeno per arrivare alla decina
                        const maxB = Math.min(9, 100 - a); // Massimo 9 e non superare 100
                        
                        if (maxB >= minB) {
                            b = Math.floor(Math.random() * (maxB - minB + 1)) + minB;
                        } else {
                            continue; // Riprova
                        }
                        
                        // Verifica finale: deve fare tappa e b deve essere 1-9
                        if (b < 1 || b > 9 || (unitsOfA + (b % 10)) <= 10) {
                            continue;
                        }
                        break;
                    case 4: // Numeri oltre le decine SENZA riporto (max 100)
                        // Genera due numeri che sommati NON richiedano riporto
                        const decineA = Math.floor(Math.random() * 5) + 1; // 1-5 (decine di a)
                        const unitaA = Math.floor(Math.random() * 9) + 1;   // 1-9 (unità di a)
                        a = decineA * 10 + unitaA;
                        
                        const maxDecineB = Math.floor((100 - a) / 10); // Max decine per b
                        const maxUnitaB = 9 - unitaA; // Max unità per b (senza riporto)
                        
                        const decineB = Math.floor(Math.random() * Math.min(maxDecineB, 4)) + 1; // 1-4
                        const unitaB = Math.floor(Math.random() * (maxUnitaB + 1)); // 0 a maxUnitaB
                        b = decineB * 10 + unitaB;
                        
                        // Verifica finale: nessun riporto e non supera 100
                        if ((unitaA + unitaB > 9) || (a + b > 100)) {
                            continue; // Riprova
                        }
                        break;
                }
                
                // Controllo finale: nessun risultato deve superare 100
                if (a + b > 100) {
                    continue;
                }
                
                attempts++;
            } while (gameUsedQuestions.has(`${a}+${b}`) && attempts < maxAttempts);
            
            const questionKey = `${a}+${b}`;
            gameUsedQuestions.add(questionKey);
            return {a, b, result: a + b, operation: '+'};
        }

        function generateSubtraction(level) {
            let a, b, attempts = 0;
            const maxAttempts = 100;
            
            do {
                switch(level) {
                    case 1: // Amici del 10
                        a = 10;
                        b = Math.floor(Math.random() * 9) + 1;
                        break;
                    case 2: // Unità - unità
                        a = Math.floor(Math.random() * 9) + 1;
                        b = Math.floor(Math.random() * a) + 1;
                        break;
                    case 3: // Decine - unità
                        a = (Math.floor(Math.random() * 9) + 1) * 10;
                        b = Math.floor(Math.random() * 9) + 1;
                        break;
                    case 4: { // Tappa alla decina precedente - CORRETTO
                        // Genera numeri che richiedano SEMPRE la tappa alla decina precedente
                        a = Math.floor(Math.random() * 80) + 20; // Da 20 a 99
                        
                        // Le unità di a DEVONO essere minori del sottraendo per richiedere prestito
                        const unitaA4 = a % 10;
                        
                        // b deve essere compreso tra 1 e 9 (CORRETTO)
                        // e deve avere unità maggiori di quelle di a per fare tappa
                        const minUnitaB4 = Math.max(1, unitaA4 + 1); // Almeno 1 e maggiore delle unità di a
                        const maxUnitaB4 = 9; // Massimo 9 (sottraendo 1-9)
                        
                        if (minUnitaB4 <= maxUnitaB4) {
                            b = Math.floor(Math.random() * (maxUnitaB4 - minUnitaB4 + 1)) + minUnitaB4;
                        } else {
                            // Se le unità di a sono già 9, modifica a
                            const decineA4 = Math.floor(a / 10);
                            const nuoveUnitaA4 = Math.floor(Math.random() * 8); // 0-7 (così b può avere unità 1-8)
                            a = decineA4 * 10 + nuoveUnitaA4;
                            
                            b = Math.floor(Math.random() * (9 - nuoveUnitaA4)) + nuoveUnitaA4 + 1;
                        }
                        
                        // Verifica finale: deve richiedere prestito e b è 1-9
                        if (b < 1 || b > 9 || (a % 10) >= (b % 10) || a <= b) {
                            continue; // Riprova
                        }
                        break;
                    }
                    case 5: { // Senza prestito - CORRETTO
                        a = Math.floor(Math.random() * 80) + 20;
                        // Genera b in modo che NON serva prestito
                        const decineA5 = Math.floor(a / 10);
                        const unitaA5 = a % 10;
                        
                        // Le decine di b devono essere <= decine di a
                        const maxDecineB5 = Math.min(decineA5 - 1, 7); // Limita per sicurezza
                        const decineB5 = Math.floor(Math.random() * maxDecineB5) + 1;
                        
                        // Le unità di b devono essere <= unità di a (nessun prestito)
                        const maxUnitaB5 = unitaA5;
                        const unitaB5 = Math.floor(Math.random() * (maxUnitaB5 + 1));
                        
                        b = decineB5 * 10 + unitaB5;
                        
                        // Verifica finale: nessun prestito necessario
                        if (unitaA5 < unitaB5 || a <= b) {
                            continue; // Riprova
                        }
                        break;
                    }
                }
                
                // Controllo: il risultato deve essere positivo
                if (a <= b) {
                    continue;
                }
                
                attempts++;
            } while (gameUsedQuestions.has(`${a}-${b}`) && attempts < maxAttempts);
            
            const questionKey = `${a}-${b}`;
            gameUsedQuestions.add(questionKey);
            return {a, b, result: a - b, operation: '-'};
        }

        function generateMultiplication(level) {
            // Usa il sistema anti-ripetizione avanzato per le tabelline
            return generateMultiplicationAdvanced();
        }

        // NUOVA FUNZIONE: Genera divisioni
        function generateDivision(level) {
            let dividend, divisor, quotient, remainder = 0, attempts = 0;
            const maxAttempts = 100;
            
            do {
                divisor = Math.floor(Math.random() * 9) + 1; // Divisore da 1 a 9 (tabelline)
                quotient = Math.floor(Math.random() * 10) + 1; // Quoziente da 1 a 10
                
                switch(level) {
                    case 1: // Divisioni senza resto
                        dividend = divisor * quotient;
                        remainder = 0;
                        break;
                    case 2: // Divisioni con resto
                        dividend = divisor * quotient;
                        remainder = Math.floor(Math.random() * (divisor - 1)) + 1; // Resto da 1 a (divisor-1)
                        dividend += remainder;
                        break;
                }
                
                attempts++;
            } while (gameUsedQuestions.has(`${dividend}÷${divisor}`) && attempts < maxAttempts);
            
            const questionKey = `${dividend}÷${divisor}`;
            gameUsedQuestions.add(questionKey);
            
            return {
                a: dividend,
                b: divisor,
                result: quotient,
                remainder: remainder,
                operation: '÷',
                hasRemainder: level === 2
            };
        }

        // NUOVA FUNZIONE: Genera divisioni per potenze di 10
        function generateDivisionPowers(level) {
            let dividend, divisor, attempts = 0;
            const maxAttempts = 100;
            
            do {
                switch(level) {
                    case 1: // Numeri da 10 a 90 ÷ 10 (risultato 1-9)
                        dividend = (Math.floor(Math.random() * 9) + 1) * 10; // 10, 20, 30...90
                        divisor = 10;
                        break;
                    case 2: // Numeri da 100 a 9990 ÷ 10 (risultato 10-999)
                        dividend = (Math.floor(Math.random() * 989) + 10) * 10; // 100, 110...9990
                        divisor = 10;
                        break;
                    case 3: // Numeri da 100 a 900 ÷ 100 (risultato 1-9)
                        dividend = (Math.floor(Math.random() * 9) + 1) * 100; // 100, 200...900
                        divisor = 100;
                        break;
                    case 4: // Numeri da 1000 a 9900 ÷ 100 (risultato 10-99)
                        dividend = (Math.floor(Math.random() * 90) + 10) * 100; // 1000, 1100...9900
                        divisor = 100;
                        break;
                    case 5: // Numeri da 1000 a 9000 ÷ 1000 (risultato 1-9)
                        dividend = (Math.floor(Math.random() * 9) + 1) * 1000; // 1000, 2000...9000
                        divisor = 1000;
                        break;
                    case 6: // Divisioni miste: ÷10, ÷100, ÷1000
                        const divisors6 = [10, 100, 1000];
                        divisor = divisors6[Math.floor(Math.random() * divisors6.length)];
                        
                        if (divisor === 10) {
                            // Mix tra risultati 1-9 e 10-99
                            if (Math.random() < 0.5) {
                                dividend = (Math.floor(Math.random() * 9) + 1) * 10; // 10-90
                            } else {
                                dividend = (Math.floor(Math.random() * 90) + 10) * 10; // 100-990
                            }
                        } else if (divisor === 100) {
                            // Mix tra risultati 1-9 e 10-99
                            if (Math.random() < 0.5) {
                                dividend = (Math.floor(Math.random() * 9) + 1) * 100; // 100-900
                            } else {
                                dividend = (Math.floor(Math.random() * 90) + 10) * 100; // 1000-9900
                            }
                        } else { // divisor === 1000
                            // Mix tra risultati 1-9 e alcuni 10-99
                            if (Math.random() < 0.7) {
                                dividend = (Math.floor(Math.random() * 9) + 1) * 1000; // 1000-9000 (risultato 1-9)
                            } else {
                                dividend = (Math.floor(Math.random() * 90) + 10) * 1000; // 10000-99000 (risultato 10-99)
                            }
                        }
                        break;
                    case 7: // Divisioni miste avanzate: ÷10, ÷100, ÷1000 (dividendi max 9999)
                        const divisors7 = [10, 100, 1000];
                        divisor = divisors7[Math.floor(Math.random() * divisors7.length)];
                        
                        if (divisor === 10) {
                            // Range limitato alle unità di migliaia: da 10 a 9990
                            const range = Math.random();
                            if (range < 0.3) {
                                dividend = (Math.floor(Math.random() * 9) + 1) * 10; // 10-90 (risultato 1-9)
                            } else if (range < 0.7) {
                                dividend = (Math.floor(Math.random() * 90) + 10) * 10; // 100-990 (risultato 10-99)
                            } else {
                                dividend = (Math.floor(Math.random() * 900) + 100) * 10; // 1000-9990 (risultato 100-999)
                            }
                        } else if (divisor === 100) {
                            // Range limitato alle unità di migliaia: da 100 a 9900
                            const range = Math.random();
                            if (range < 0.4) {
                                dividend = (Math.floor(Math.random() * 9) + 1) * 100; // 100-900 (risultato 1-9)
                            } else if (range < 0.8) {
                                dividend = (Math.floor(Math.random() * 90) + 10) * 100; // 1000-9900 (risultato 10-99)
                            } else {
                                dividend = (Math.floor(Math.random() * 9) + 1) * 1000 + (Math.floor(Math.random() * 9) + 1) * 100; // 1100-9900 (risultato 11-99)
                            }
                        } else { // divisor === 1000
                            // Range limitato alle unità di migliaia: da 1000 a 9000 (risultato 1-9)
                            dividend = (Math.floor(Math.random() * 9) + 1) * 1000; // 1000-9000 (risultato 1-9)
                        }
                        break;
                }
                
                attempts++;
            } while (gameUsedQuestions.has(`${dividend}÷${divisor}`) && attempts < maxAttempts);
            
            const questionKey = `${dividend}÷${divisor}`;
            gameUsedQuestions.add(questionKey);
            
            return {
                a: dividend,
                b: divisor,
                result: dividend / divisor,
                operation: '÷'
            };
        }

        function generateMultiplicationPowers(level) {
            let a, multiplier, attempts = 0;
            const maxAttempts = 100;
            
            do {
                switch(level) {
                    case 1: // Numeri da 1 a 9 × 10
                        a = Math.floor(Math.random() * 9) + 1; // 1-9
                        multiplier = 10;
                        break;
                    case 2: // Numeri da 10 a 99 × 10
                        a = Math.floor(Math.random() * 90) + 10; // 10-99
                        multiplier = 10;
                        break;
                    case 3: // Numeri da 1 a 9 × 100
                        a = Math.floor(Math.random() * 9) + 1; // 1-9
                        multiplier = 100;
                        break;
                    case 4: // Numeri da 10 a 99 × 100
                        a = Math.floor(Math.random() * 90) + 10; // 10-99
                        multiplier = 100;
                        break;
                    case 5: // Numeri da 1 a 9 × 1000
                        a = Math.floor(Math.random() * 9) + 1; // 1-9
                        multiplier = 1000;
                        break;
                }
                
                attempts++;
            } while (gameUsedQuestions.has(`${a}×${multiplier}`) && attempts < maxAttempts);
            
            const questionKey = `${a}×${multiplier}`;
            gameUsedQuestions.add(questionKey);
            
            return {
                a: a,
                b: multiplier, 
                result: a * multiplier,
                operation: '×'
            };
        }

        // ========================================
        // FUNZIONI PRINCIPALI DEL GIOCO
        // ========================================
        
        function startGame(gameType) {
            playClickSound(); // Assicura il suono
            
            // Chiudi entrambi i sottomenu se aperti
            if (isMultiplicationMenuOpen) {
                toggleMultiplicationMenu();
            }
            if (isDivisionMenuOpen) {
                toggleDivisionMenu();
            }
            
            currentGame = gameType;
            currentLevel = 1;
            currentQuestion = 1;
            correctAnswers = 0;
            totalErrors = 0;
            usedQuestions = [];
            
            // Reset completo domande utilizzate per nuovo gioco
            gameUsedQuestions.clear();
            onesTableUsed = false;
            
            // Inizializza le tabelline se necessario
            if (gameType === 'tabelline') {
                initializeTabellineQuestions();
            }
            
            questionsPerLevel = gameConfigs[gameType].questionsPerLevel;

            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('active');
            document.getElementById('level-complete-screen').classList.add('hidden');

            updateGameUI();
            generateQuestion();
            
            // Assicurati che il bottone conferma sia nello stato corretto
            setTimeout(updateConfirmButton, 100);
        }

        function updateGameUI() {
            const config = gameConfigs[currentGame];
            document.getElementById('game-title').textContent = config.title;
            document.getElementById('level-description').textContent = config.descriptions[currentLevel - 1];
            document.getElementById('current-level').textContent = currentLevel;
            document.getElementById('current-question').textContent = currentQuestion;
            document.getElementById('correct-answers').textContent = correctAnswers;
            
            const progress = (currentQuestion - 1) / questionsPerLevel * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
        }

        function generateQuestion() {
            let questionData;
            let attempts = 0;
            const maxAttempts = 50;
            
            // Genera domanda senza ripetizioni
            do {
                switch(currentGame) {
                    case 'addizioni':
                        questionData = generateAddition(currentLevel);
                        break;
                    case 'sottrazioni':
                        questionData = generateSubtraction(currentLevel);
                        break;
                    case 'tabelline':
                        questionData = generateMultiplication(currentLevel);
                        break;
                    case 'moltiplicazioni_potenze':
                        questionData = generateMultiplicationPowers(currentLevel);
                        break;
                    case 'divisioni':
                        questionData = generateDivision(currentLevel);
                        break;
                    case 'divisioni_potenze':
                        questionData = generateDivisionPowers(currentLevel);
                        break;
                }
                attempts++;
            } while (attempts < maxAttempts && !questionData);

            currentQuestionData = questionData;
            
            // Visualizza la domanda
            if (questionData.hasRemainder) {
                document.getElementById('question').textContent = 
                    `${questionData.a} ${questionData.operation} ${questionData.b} = ? resto ?`;
                // Mostra il campo resto
                document.getElementById('remainder-group').classList.remove('hidden');
                document.getElementById('quotient-label').textContent = 'Quoziente';
            } else {
                document.getElementById('question').textContent = 
                    `${questionData.a} ${questionData.operation} ${questionData.b} = `;
                // Nascondi il campo resto
                document.getElementById('remainder-group').classList.add('hidden');
                document.getElementById('quotient-label').textContent = 'Risultato';
            }
            
            document.getElementById('answer-input').value = '';
            document.getElementById('remainder-input').value = '';
            document.getElementById('answer-input').focus();
            document.getElementById('feedback').className = 'feedback hidden';
            
            // Aggiorna lo stato del bottone conferma
            updateConfirmButton();
            
            // Debug: mostra quante domande sono state usate (solo in console)
            console.log(`Domande utilizzate: ${gameUsedQuestions.size}, Livello: ${currentLevel}, Domanda: ${currentQuestion}`);
        }

        // Funzione per aggiornare lo stato del bottone conferma
        function updateConfirmButton() {
            const confirmBtn = document.getElementById('confirm-btn');
            const answerInput = document.getElementById('answer-input');
            const remainderInput = document.getElementById('remainder-input');
            const remainderGroup = document.getElementById('remainder-group');
            
            if (remainderGroup.classList.contains('hidden')) {
                // Solo quoziente necessario
                if (answerInput.value.trim() !== '') {
                    confirmBtn.disabled = false;
                    confirmBtn.style.opacity = '1';
                    confirmBtn.style.cursor = 'pointer';
                } else {
                    confirmBtn.disabled = true;
                    confirmBtn.style.opacity = '0.5';
                    confirmBtn.style.cursor = 'not-allowed';
                }
            } else {
                // Entrambi i campi necessari
                if (answerInput.value.trim() !== '' && remainderInput.value.trim() !== '') {
                    confirmBtn.disabled = false;
                    confirmBtn.style.opacity = '1';
                    confirmBtn.style.cursor = 'pointer';
                } else {
                    confirmBtn.disabled = true;
                    confirmBtn.style.opacity = '0.5';
                    confirmBtn.style.cursor = 'not-allowed';
                }
            }
        }

        function checkAnswer() {
            playClickSound(); // Assicura il suono per il click
            
            // Controlla se il bottone è disabilitato
            const confirmBtn = document.getElementById('confirm-btn');
            if (confirmBtn.disabled) {
                return; // Non procede se il bottone è disabilitato
            }
            
            const userQuotient = parseInt(document.getElementById('answer-input').value);
            const userRemainder = parseInt(document.getElementById('remainder-input').value) || 0;
            let correctQuotient = currentQuestionData.result;
            let correctRemainder = currentQuestionData.remainder || 0;
            const feedbackElement = document.getElementById('feedback');

            if (currentQuestionData.hasRemainder) {
                // Controlla sia quoziente che resto
                if (userQuotient === correctQuotient && userRemainder === correctRemainder) {
                    correctAnswers++;
                    feedbackElement.textContent = `✅ Perfetto! ${currentQuestionData.a} ÷ ${currentQuestionData.b} = ${correctQuotient} resto ${correctRemainder}`;
                    feedbackElement.className = 'feedback correct';
                    playCorrectSound(); // Assicura il suono per risposta corretta
                } else {
                    totalErrors++;
                    feedbackElement.textContent = `❌ Non è corretto. La risposta giusta è ${correctQuotient} resto ${correctRemainder}`;
                    feedbackElement.className = 'feedback incorrect';
                    playIncorrectSound(); // Assicura il suono per risposta sbagliata
                }
            } else {
                // Controlla solo il quoziente
                if (userQuotient === correctQuotient) {
                    correctAnswers++;
                    feedbackElement.textContent = '✅ Corretto! Bravo!';
                    feedbackElement.className = 'feedback correct';
                    playCorrectSound(); // Assicura il suono per risposta corretta
                } else {
                    totalErrors++;
                    feedbackElement.textContent = `❌ Non è corretto. La risposta giusta è ${correctQuotient}`;
                    feedbackElement.className = 'feedback incorrect';
                    playIncorrectSound(); // Assicura il suono per risposta sbagliata
                }
            }

            updateGameUI();
            
            setTimeout(() => {
                nextQuestion();
            }, 2000);
        }

        function nextQuestion() {
            if(currentQuestion >= questionsPerLevel) {
                completeLevel();
            } else {
                currentQuestion++;
                generateQuestion();
                updateGameUI();
            }
        }

        function completeLevel() {
            const allCorrect = correctAnswers === questionsPerLevel;
            const config = gameConfigs[currentGame];

            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('level-complete-screen').classList.remove('hidden');
            document.getElementById('level-complete-screen').classList.add('active');

            document.getElementById('final-correct').textContent = correctAnswers;
            document.getElementById('final-errors').textContent = totalErrors;
            document.getElementById('completion-level').textContent = currentLevel;

            if(allCorrect) {
                playLevelCompleteSound(); // Suono di completamento livello
                const trophies = ['🏆', '🥇', '🎖️', '⭐', '🌟'];
                const trophy = trophies[Math.min(currentLevel - 1, trophies.length - 1)];
                
                document.getElementById('trophy').textContent = trophy;
                document.getElementById('completion-title').textContent = 'Livello Completato!';
                document.getElementById('completion-message').textContent = 
                    successMessages[Math.floor(Math.random() * successMessages.length)];
                
                if(currentLevel < config.levels) {
                    document.getElementById('continue-btn').style.display = 'inline-block';
                    document.getElementById('continue-btn').textContent = 'Livello Successivo 🚀';
                } else {
                    document.getElementById('continue-btn').style.display = 'inline-block';
                    document.getElementById('continue-btn').textContent = 'Hai Completato Tutto! 🎉';
                }
            } else {
                document.getElementById('trophy').textContent = '📚';
                document.getElementById('completion-title').textContent = 'Riprova!';
                document.getElementById('completion-message').textContent = 
                    encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)];
                document.getElementById('continue-btn').style.display = 'inline-block';
                document.getElementById('continue-btn').textContent = 'Riprova Livello 🔄';
            }
        }

        function continueGame() {
            playClickSound(); // Assicura il suono
            
            const config = gameConfigs[currentGame];
            const allCorrect = correctAnswers === questionsPerLevel;

            if(allCorrect && currentLevel < config.levels) {
                currentLevel++;
            }
            
            if(allCorrect && currentLevel > config.levels) {
                goHome();
                return;
            }

            currentQuestion = 1;
            correctAnswers = 0;
            totalErrors = 0;
            
            // NON resetto gameUsedQuestions per evitare ripetizioni tra livelli
            // Per le tabelline mantiene il sistema avanzato attivo

            document.getElementById('level-complete-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('active');

            updateGameUI();
            generateQuestion();
        }

        function goHome() {
            playClickSound(); // Assicura il suono
            
            // Chiudi entrambi i sottomenu se aperti
            if (isMultiplicationMenuOpen) {
                const submenu = document.getElementById('multiplication-submenu');
                const btn = document.getElementById('multiplication-btn');
                submenu.classList.remove('active');
                btn.classList.remove('expanded');
                isMultiplicationMenuOpen = false;
            }
            if (isDivisionMenuOpen) {
                const submenu = document.getElementById('division-submenu');
                const btn = document.getElementById('division-btn');
                submenu.classList.remove('active');
                btn.classList.remove('expanded');
                isDivisionMenuOpen = false;
            }
            
            // Torna al menu principale del gioco matematica invece che all'index
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('level-complete-screen').classList.add('hidden');
            document.getElementById('main-menu').style.display = 'grid';
            
            // Reset delle variabili di gioco
            currentGame = '';
            currentLevel = 1;
            currentQuestion = 1;
            correctAnswers = 0;
            totalErrors = 0;
            gameUsedQuestions.clear();
            onesTableUsed = false;
            
            // Reset tabelline
            tabellineQuestions = [];
            tabellineCurrentIndex = 0;
        }

        // ========================================
        // EVENT LISTENERS E INIZIALIZZAZIONE
        // ========================================
        
        // Event listeners
        document.getElementById('answer-input').addEventListener('keypress', function(e) {
            if(e.key === 'Enter') {
                const remainderGroup = document.getElementById('remainder-group');
                if (!remainderGroup.classList.contains('hidden')) {
                    // Se c'è il campo resto, sposta il focus lì
                    const remainderInput = document.getElementById('remainder-input');
                    if (remainderInput.value.trim() === '') {
                        remainderInput.focus();
                        return;
                    }
                }
                // Se non c'è il campo resto o è già compilato, conferma
                const confirmBtn = document.getElementById('confirm-btn');
                if (!confirmBtn.disabled) {
                    checkAnswer();
                }
            }
        });

        document.getElementById('answer-input').addEventListener('input', updateConfirmButton);

        // Event listener per il campo resto
        document.getElementById('remainder-input').addEventListener('keypress', function(e) {
            if(e.key === 'Enter') {
                const confirmBtn = document.getElementById('confirm-btn');
                if (!confirmBtn.disabled) {
                    checkAnswer();
                }
            }
        });

        document.getElementById('remainder-input').addEventListener('input', updateConfirmButton);

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('main-menu').style.display = 'grid';
            
            // Controlla stato PWA (solo log, nessun indicatore visivo)
            checkPWAInstallationStatus();
            updateOnlineStatus();
            
            // Imposta lo stato iniziale del bottone conferma
            updateConfirmButton();
            
            // Inizializza audio al primo click dell'utente
            document.addEventListener('click', function initializeAudio() {
                initAudio();
                document.removeEventListener('click', initializeAudio);
            }, { once: true });

            // Aggiungi suoni di click a tutti i bottoni che non hanno già il suono
            document.querySelectorAll('button').forEach(button => {
                // Non aggiungere listener duplicati per bottoni che già chiamano playClickSound
                if (!button.onclick || button.onclick.toString().indexOf('playClickSound') === -1) {
                    button.addEventListener('click', () => {
                        playClickSound();
                    });
                }
            });
            
            // Integrazione completa con sistema PWA unificato
            console.log('🧮 Matematica sul Divano 3ª v4.1.0 - Sistema Migliorato');
            console.log('✨ Bottone Home funzionante aggiunto');
            console.log('🔧 Correzioni: Addizioni L3, Sottrazioni L4, Tabelline Anti-Ripetizione');
            console.log('🎯 Tabelline: Sistema avanzato con pre-generazione e mescolamento');
        });

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
</script>
</body>
</html>

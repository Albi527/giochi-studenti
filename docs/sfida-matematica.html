<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sfida Matematica in Famiglia 3¬™</title>
    <style>
        :root {
            --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary: linear-gradient(135deg, #98d8a8 0%, #a8e6a3 50%, #b8f5b8 100%);
            --accent: linear-gradient(45deg, #ff6b6b, #ffa500);
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --light: #f8f9fa;
            --dark: #343a40;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: var(--primary);
            min-height: 100vh;
            overflow-x: hidden;
            /* iOS Safari fixes */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.97) 0%, rgba(248, 250, 255, 0.97) 100%);
            backdrop-filter: blur(15px);
            z-index: 1000;
            padding: 10px 20px;
            box-shadow: 0 2px 20px rgba(102, 126, 234, 0.15);
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 800px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            flex: 1;
        }

        .header-subtitle {
            font-size: clamp(0.8rem, 2vw, 1rem);
            color: #666;
            text-align: center;
            margin-top: 2px;
        }

        .header-btn {
            background: var(--accent);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            /* iOS touch fixes */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .header-btn:hover, .header-btn:active {
            transform: scale(1.1);
        }

        .main-content {
            margin-top: 100px;
            padding-bottom: 20px;
            overflow-x: hidden;
            background: transparent;
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
            overflow-x: hidden;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 255, 0.95) 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(102, 126, 234, 0.1);
            overflow-x: hidden;
        }

        .btn {
            background: var(--secondary);
            border: none;
            border-radius: 12px;
            padding: 15px 25px;
            font-size: clamp(1rem, 3vw, 1.2rem);
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-height: 44px;
            width: 100%;
            margin: 10px 0;
            /* iOS touch fixes */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-appearance: none;
        }

        .btn:hover, .btn:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .grid {
            display: grid;
            gap: 15px;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .grid-5 {
            grid-template-columns: repeat(5, 1fr);
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        /* Responsive avatar grid */
        @media (max-width: 375px) {
            .avatar-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
        }

        @media (max-width: 320px) {
            .avatar-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }
        }

        .avatar-btn {
            aspect-ratio: 1;
            font-size: 2rem;
            border: 3px solid transparent;
            border-radius: 12px;
            background: linear-gradient(135deg, #fdf7ff 0%, #f3f0ff 100%);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
            /* iOS touch fixes */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-appearance: none;
        }

        .avatar-btn:hover, .avatar-btn.selected, .avatar-btn:active {
            border-color: #667eea;
            transform: scale(1.1);
            background: rgba(102, 126, 234, 0.1);
        }

        .profile-card {
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s ease;
            position: relative;
            /* iOS touch fixes */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .profile-card:hover, .profile-card:active {
            transform: translateY(-5px);
        }

        .profile-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 14px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            /* iOS touch fixes */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-appearance: none;
        }

        .profile-delete-btn:hover, .profile-delete-btn:active {
            transform: scale(1.1);
            background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.5);
        }

        .profile-card-content {
            pointer-events: none;
            position: relative;
            z-index: 1;
        }

        .profile-delete-btn:active {
            transform: scale(0.95);
        }

        .profile-avatar {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .challenge-card {
            position: relative;
            overflow: hidden;
            text-align: left;
            /* iOS touch fixes */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .challenge-card h3 {
            text-align: left !important;
        }

        .challenge-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: rotate(45deg);
            transition: all 0.6s;
            opacity: 0;
        }

        .challenge-card:hover::before {
            animation: shine 0.6s ease-in-out;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); opacity: 0; }
        }

        .progress-bar {
            width: 100%;
            height: clamp(15px, 4vw, 25px);
            background: linear-gradient(135deg, rgba(0,0,0,0.05) 0%, rgba(102, 126, 234, 0.1) 100%);
            border-radius: clamp(8px, 2vw, 15px);
            overflow: hidden;
            margin: clamp(8px, 2vw, 15px) 0;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
            border-radius: clamp(8px, 2vw, 15px);
        }

        .question-card {
            font-size: clamp(1.1rem, 4vw, 1.6rem);
            text-align: center;
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            background: linear-gradient(135deg, rgba(255, 248, 250, 0.95) 0%, rgba(240, 244, 255, 0.95) 100%);
            padding: clamp(20px, 5vw, 35px);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.15);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
            color: #333;
            margin: clamp(15px, 4vw, 25px) 0;
            max-width: 100%;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(140px, 45vw), 1fr));
            gap: clamp(10px, 3vw, 20px);
            margin: clamp(20px, 5vw, 40px) 0;
            overflow-x: visible;
        }

        .option-btn {
            aspect-ratio: 1.8;
            font-size: clamp(1rem, 3vw, 1.3rem);
            border: 2px solid rgba(102, 126, 234, 0.3);
            background: linear-gradient(135deg, rgba(255, 250, 252, 0.95) 0%, rgba(240, 244, 255, 0.95) 100%);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
            text-align: center;
            padding: clamp(5px, 2vw, 10px);
            color: #333;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
            min-height: 44px;
            /* iOS touch fixes */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-appearance: none;
        }

        /* Responsive option buttons */
        @media (max-width: 500px) {
            .options-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                margin: 25px 0;
            }
            
            .option-btn {
                aspect-ratio: 2.5;
                min-height: 50px;
            }
        }

        @media (max-width: 375px) {
            .option-btn {
                aspect-ratio: 2.2;
                font-size: clamp(0.95rem, 4vw, 1.1rem);
            }
        }

        /* Landscape mobile - compact options */
        @media (max-height: 500px) and (orientation: landscape) {
            .options-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                margin: 15px 0;
            }
            
            .option-btn {
                aspect-ratio: 2;
                min-height: 40px;
                font-size: clamp(0.9rem, 2.5vw, 1rem);
            }
        }

        .option-btn:hover, .option-btn:active {
            border-color: #667eea;
            transform: scale(1.05);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(200, 210, 255, 0.3) 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .option-btn.correct {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .option-btn.incorrect {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .timer {
            font-size: clamp(1.5rem, 5vw, 2rem);
            font-weight: bold;
            text-align: center;
            color: #667eea;
            margin: 20px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(240, 244, 255, 0.9) 100%);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }

        .stat-value {
            font-size: clamp(2rem, 6vw, 3rem);
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
            color: #666;
            margin-top: 5px;
        }

        .trophy {
            font-size: clamp(4rem, 12vw, 6rem);
            text-align: center;
            margin: 20px 0;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-30px); }
            60% { transform: translateY(-15px); }
        }

        .input-group {
            margin: 20px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            font-size: 1.1rem;
            font-family: inherit;
            transition: border-color 0.3s ease;
            background: linear-gradient(135deg, rgba(255, 250, 252, 0.95) 0%, rgba(245, 248, 255, 0.95) 100%);
            color: #333;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.05);
            /* iOS fixes */
            -webkit-appearance: none;
            -webkit-border-radius: 12px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: clamp(5px, 2vw, 15px);
        }

        /* Improved game-info for small screens */
        @media (max-width: 500px) {
            .game-info {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
            
            .game-info > * {
                flex: none;
            }
        }

        /* Landscape mobile optimization */
        @media (max-height: 500px) and (orientation: landscape) {
            .game-info {
                flex-direction: row;
                justify-content: space-around;
                margin-bottom: 10px;
                gap: 5px;
            }
            
            .question-counter, .timer, .score {
                font-size: clamp(0.9rem, 2.5vw, 1rem);
            }
        }

        .question-counter {
            font-size: clamp(1rem, 3vw, 1.2rem);
            font-weight: bold;
            color: #667eea;
        }

        .score {
            font-size: clamp(1rem, 3vw, 1.2rem);
            font-weight: bold;
            color: #28a745;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .main-content {
                margin-top: 90px;
            }
            
            .card {
                padding: 15px;
                margin: 15px 0;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        @media (max-width: 480px) {
            .avatar-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 8px;
            }
            
            .avatar-btn {
                font-size: 1.5rem;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }
            
            /* Dashboard buttons responsive */
            .dashboard-buttons {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .dashboard-buttons .btn {
                max-width: none !important;
            }
        }

        .rules-section {
            margin-bottom: 25px;
        }

        .rules-section h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: clamp(1.1rem, 3vw, 1.3rem);
        }

        .rules-section p, .rules-section li {
            line-height: 1.6;
            color: #333;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
        }

        .rules-section ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .challenge-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .status-completed {
            background: var(--success);
            color: white;
        }

        .status-available {
            background: var(--warning);
            color: white;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pattern-sequence {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 10px;
            font-size: clamp(1.5rem, 4vw, 2rem);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(240, 244, 255, 0.8) 100%);
            padding: 10px 15px;
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .pattern-item {
            display: inline-block;
            min-width: 30px;
            text-align: center;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 6px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .color-square {
            width: 25px;
            height: 25px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            display: inline-block;
            margin: 0 3px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.1);
        }

        /* High DPI displays optimization */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .header-btn, .option-btn, .btn {
                box-shadow: 0 1px 3px rgba(102, 126, 234, 0.12), 0 1px 2px rgba(102, 126, 234, 0.24);
            }
        }

        /* Foldable devices and unusual aspect ratios */
        @media (min-aspect-ratio: 3/1) {
            .container {
                max-width: 70vw;
                margin: 0 auto;
            }
            
            .options-grid {
                grid-template-columns: repeat(4, 1fr);
                max-width: 800px;
                margin: 20px auto;
            }
        }

        /* Very tall screens (like some phones in portrait) */
        @media (max-aspect-ratio: 1/2) {
            .card {
                margin: clamp(15px, 2vh, 25px) 0;
            }
            
            .question-card {
                margin: clamp(20px, 3vh, 30px) 0;
            }
            
            .trophy {
                margin: clamp(15px, 2vh, 20px) 0;
            }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .bounce, .fade-in, .pulse {
                animation: none !important;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .card, .option-btn, .input-group input {
                border-width: 2px;
                border-color: #333;
            }
            
            .option-btn {
                background: white;
                color: #000;
            }
            
            .option-btn.correct {
                background: #0f5132;
                color: white;
            }
            
            .option-btn.incorrect {
                background: #842029;
                color: white;
            }
        }

        /* iOS Safari specific fixes */
        @supports (-webkit-touch-callout: none) {
            .btn, .option-btn, .avatar-btn, .profile-card {
                -webkit-tap-highlight-color: rgba(0,0,0,0);
                -webkit-user-select: none;
            }
            
            /* Fix button appearance on iOS */
            input[type="button"], input[type="submit"], button {
                -webkit-appearance: none;
                border-radius: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <button class="header-btn" id="homeBtn">üè†</button>
            <div>
                <h1>Sfida Matematica in Famiglia 3¬™</h1>
                <div class="header-subtitle">by Maestro Alberto</div>
            </div>
            <button class="header-btn" id="soundBtn">üîä</button>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="screen active">
                <div class="card">
                    <h2 style="text-align: center; color: #667eea; margin-bottom: 30px;">Benvenuto alla Sfida Matematica!</h2>
                    <div class="grid grid-2">
                        <button class="btn btn-primary" data-action="showRules">üìö Regole del Gioco</button>
                        <button class="btn btn-success" data-action="showProfiles">üë§ Scegli Profilo</button>
                    </div>
                </div>
            </div>

            <!-- Rules Screen -->
            <div id="rulesScreen" class="screen">
                <div class="card">
                    <h2 style="text-align: center; color: #667eea; margin-bottom: 30px;">üìö Regole del Gioco</h2>
                    
                    <div class="rules-section">
                        <h3>üéØ Obiettivo</h3>
                        <p>Completa le sfide matematiche giornaliere per diventare il campione di matematica della tua famiglia!</p>
                    </div>

                    <div class="rules-section">
                        <h3>‚ö° Come Funziona</h3>
                        <ul>
                            <li>Ogni giorno hai a disposizione <strong>3 sfide</strong> matematiche</li>
                            <li>Ogni sfida contiene <strong>30 domande</strong> di matematica</li>
                            <li>Puoi giocare ogni sfida <strong>una sola volta al giorno</strong></li>
                            <li>Le sfide si rinnovano automaticamente a <strong>mezzanotte</strong></li>
                        </ul>
                    </div>

                    <div class="rules-section">
                        <h3>üìä Punteggio</h3>
                        <ul>
                            <li>Ogni risposta corretta vale <strong>10 punti</strong></li>
                            <li>Punteggio massimo per sfida: <strong>300 punti</strong></li>
                            <li>Il tempo impiegato viene registrato ma non influenza il punteggio</li>
                        </ul>
                    </div>

                    <div class="rules-section">
                        <h3>üèÜ Trofei</h3>
                        <ul>
                            <li>üèÜ <strong>Oro</strong>: 90% o pi√π di risposte corrette</li>
                            <li>ü•à <strong>Argento</strong>: 70-89% di risposte corrette</li>
                            <li>ü•â <strong>Bronzo</strong>: Meno del 70% di risposte corrette</li>
                        </ul>
                    </div>

                    <div class="rules-section">
                        <h3>üìö Tipi di Domande</h3>
                        <ul>
                            <li><strong>Calcolo</strong>: Operazioni matematiche di base</li>
                            <li><strong>Logica</strong>: Sequenze e pattern</li>
                            <li><strong>Problemi</strong>: Situazioni della vita reale</li>
                            <li><strong>Geometria</strong>: Forme e figure</li>
                        </ul>
                    </div>

                    <button class="btn btn-primary" data-action="showWelcome">üîô Torna Indietro</button>
                </div>
            </div>

            <!-- Profiles Screen -->
            <div id="profilesScreen" class="screen">
                <div class="card">
                    <h2 style="text-align: center; color: #667eea; margin-bottom: 30px;">üë§ Scegli il tuo Profilo</h2>
                    <div id="profilesList" class="grid grid-3">
                        <!-- Profili verranno caricati qui -->
                    </div>
                    <button class="btn btn-success" data-action="showCreate">‚ûï Crea Nuovo Profilo</button>
                    <button class="btn" data-action="showWelcome">üîô Torna Indietro</button>
                </div>
            </div>

            <!-- Create Profile Screen -->
            <div id="createScreen" class="screen">
                <div class="card">
                    <h2 style="text-align: center; color: #667eea; margin-bottom: 30px;">‚ú® Crea il tuo Profilo</h2>
                    
                    <div class="input-group">
                        <label for="playerName">Il tuo nome:</label>
                        <input type="text" id="playerName" maxlength="20" placeholder="Inserisci il tuo nome...">
                    </div>

                    <div class="input-group">
                        <label>Scegli il tuo avatar:</label>
                        <div class="avatar-grid" id="avatarGrid">
                            <button class="avatar-btn" data-avatar="üë¶">üë¶</button>
                            <button class="avatar-btn" data-avatar="üëß">üëß</button>
                            <button class="avatar-btn" data-avatar="üßí">üßí</button>
                            <button class="avatar-btn" data-avatar="üë®">üë®</button>
                            <button class="avatar-btn" data-avatar="üë©">üë©</button>
                            <button class="avatar-btn" data-avatar="üßë">üßë</button>
                            <button class="avatar-btn" data-avatar="üë¥">üë¥</button>
                            <button class="avatar-btn" data-avatar="üëµ">üëµ</button>
                            <button class="avatar-btn" data-avatar="ü§ñ">ü§ñ</button>
                            <button class="avatar-btn" data-avatar="ü¶∏">ü¶∏</button>
                        </div>
                    </div>

                    <button class="btn btn-success" data-action="createProfile">‚úÖ Crea Profilo</button>
                    <button class="btn" data-action="showProfiles">üîô Torna Indietro</button>
                </div>
            </div>

            <!-- Dashboard Screen -->
            <div id="dashboardScreen" class="screen">
                <div class="card">
                    <div id="playerInfo" style="text-align: center; margin-bottom: 30px;">
                        <!-- Info giocatore -->
                    </div>
                    
                    <h3 style="text-align: center; color: #667eea; margin-bottom: 20px;">üéØ Sfide di Oggi</h3>
                    <div id="challengesList" class="grid grid-3">
                        <!-- Sfide verranno caricate qui -->
                    </div>

                    <div class="dashboard-buttons" style="display: flex; justify-content: space-between; align-items: center; gap: 15px; margin-top: 20px;">
                        <button class="btn btn-success" data-action="showProfiles" style="flex: 1; max-width: 200px;">üë§ Cambia Profilo</button>
                        <button class="btn btn-primary" data-action="goBack" style="flex: 1; max-width: 200px;">üîô Indietro</button>
                    </div>
                </div>
            </div>

            <!-- Game Screen -->
            <div id="gameScreen" class="screen">
                <div class="card">
                    <div class="game-info">
                        <div class="question-counter" id="questionCounter">Domanda 1/30</div>
                        <div class="timer" id="timer">00'00''</div>
                        <div class="score" id="gameScore">Punti: 0</div>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 3.33%"></div>
                    </div>

                    <div class="question-card" id="question">
                        <!-- Domanda verr√† caricata qui -->
                    </div>

                    <div class="options-grid" id="options">
                        <!-- Opzioni verranno caricate qui -->
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-danger" data-action="confirmQuit">üö™ Abbandona Sfida</button>
                    </div>
                </div>
            </div>

            <!-- Results Screen -->
            <div id="resultsScreen" class="screen">
                <div class="card">
                    <div class="trophy" id="trophyDisplay">üèÜ</div>
                    
                    <h2 style="text-align: center; color: #667eea; margin-bottom: 30px;" id="resultTitle">Sfida Completata!</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="finalScore">0</div>
                            <div class="stat-label">Punti Totali</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="correctAnswers">0</div>
                            <div class="stat-label">Risposte Corrette</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="finalTime">00'00''</div>
                            <div class="stat-label">Tempo Impiegato</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="accuracy">0%</div>
                            <div class="stat-label">Precisione</div>
                        </div>
                    </div>

                    <button class="btn btn-primary" data-action="showDashboard">üè† Torna al Menu</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // iOS Detection and Browser Utilities - CONVERTED TO ES5
        var IOSUtils = {
            isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.userAgent.indexOf('Mac') !== -1 && 'ontouchend' in document),
            isSafari: /^((?!chrome|android).)*safari/i.test(navigator.userAgent),
            
            // Normalized date for cross-platform consistency
            getTodayString: function() {
                var now = new Date();
                var year = now.getFullYear();
                var month = String(now.getMonth() + 1);
                if (month.length === 1) month = '0' + month;
                var day = String(now.getDate());
                if (day.length === 1) day = '0' + day;
                return year + '-' + month + '-' + day;
            },
            
            // Ensure audio context is ready for iOS
            enableAudio: function() {
                if (this.isIOS && audioSystem.audioContext && audioSystem.audioContext.state === 'suspended') {
                    audioSystem.audioContext.resume();
                }
            }
        };

        // Enhanced Event System for iOS compatibility - CONVERTED TO ES5
        function EventManager() {
            this.handlers = new Map();
            this.setupEventDelegation();
        }

        EventManager.prototype.setupEventDelegation = function() {
            var self = this;
            // Use event delegation for all clickable elements
            document.addEventListener('click', function(event) {
                self.handleClick(event);
            }, true);
            
            // Add touch events for iOS
            if (IOSUtils.isIOS) {
                document.addEventListener('touchstart', function(event) {
                    self.handleTouchStart(event);
                }, { passive: true });
                document.addEventListener('touchend', function(event) {
                    self.handleTouchEnd(event);
                }, { passive: false });
            }
        };

        EventManager.prototype.handleClick = function(event) {
            var target = event.target.closest('[data-action]');
            if (target) {
                event.preventDefault();
                event.stopPropagation();
                
                var action = target.dataset.action;
                this.executeAction(action, target);
            }
        };

        EventManager.prototype.handleTouchStart = function(event) {
            // Enable audio on first touch for iOS
            IOSUtils.enableAudio();
            
            var target = event.target.closest('[data-action]');
            if (target) {
                target.classList.add('active');
            }
        };

        EventManager.prototype.handleTouchEnd = function(event) {
            var target = event.target.closest('[data-action]');
            if (target) {
                target.classList.remove('active');
                
                // Prevent double-tap zoom on iOS
                event.preventDefault();
            }
        };

        EventManager.prototype.executeAction = function(action, element) {
            audioSystem.playClick();
            
            switch (action) {
                case 'showWelcome':
                    showScreen('welcomeScreen');
                    break;
                case 'showRules':
                    showScreen('rulesScreen');
                    break;
                case 'showProfiles':
                    showScreen('profilesScreen');
                    break;
                case 'showCreate':
                    showScreen('createScreen');
                    break;
                case 'showDashboard':
                    showScreen('dashboardScreen');
                    break;
                case 'createProfile':
                    createProfile();
                    break;
                case 'confirmQuit':
                    confirmQuit();
                    break;
                case 'goHome':
                    goToIndex();
                    break;
                case 'goBack':
                    goHome();
                    break;
                case 'toggleSound':
                    toggleSound();
                    break;
                case 'startChallenge':
                    var challengeName = element.dataset.challenge;
                    startChallenge(challengeName);
                    break;
                case 'showResults':
                    var resultsData = JSON.parse(element.dataset.results);
                    var challenge = element.dataset.challenge;
                    showResults(challenge, resultsData);
                    break;
                case 'selectProfile':
                    var profileData = JSON.parse(element.dataset.profile);
                    selectProfile(profileData);
                    break;
                case 'deleteProfile':
                    var profileId = element.dataset.profileId;
                    var profileName = element.dataset.profileName;
                    deleteProfile(profileId, profileName);
                    break;
                case 'selectAvatar':
                    selectAvatar(element);
                    break;
                case 'selectAnswer':
                    var answer = element.dataset.answer;
                    var isCorrect = element.dataset.correct === 'true';
                    selectAnswer(answer, isCorrect);
                    break;
            }
        };

        // Safe event listener addition
        EventManager.prototype.addListener = function(element, event, handler) {
            if (element && typeof handler === 'function') {
                element.addEventListener(event, handler);
                
                // Store for cleanup if needed
                if (!this.handlers.has(element)) {
                    this.handlers.set(element, []);
                }
                this.handlers.get(element).push({ event: event, handler: handler });
            }
        };

        // Seeded Random Generator - CONVERTED TO ES5
        function SeededRandom(seed) {
            this.seed = seed % 2147483647;
            if (this.seed <= 0) this.seed += 2147483646;
        }

        SeededRandom.prototype.next = function() {
            this.seed = this.seed * 16807 % 2147483647;
            return (this.seed - 1) / 2147483646;
        };

        SeededRandom.prototype.int = function(min, max) {
            return Math.floor(this.next() * (max - min + 1)) + min;
        };

        SeededRandom.prototype.shuffle = function(arr) {
            var shuffled = arr.slice(); // ES5 equivalent of [...arr]
            for (var i = shuffled.length - 1; i > 0; i--) {
                var j = this.int(0, i);
                var temp = shuffled[i];
                shuffled[i] = shuffled[j];
                shuffled[j] = temp;
            }
            return shuffled;
        };

        SeededRandom.prototype.choice = function(arr) {
            return arr[this.int(0, arr.length - 1)];
        };

        // Hash function for deterministic seeds and question uniqueness
        function hashString(str) {
            var hash = 0;
            for (var i = 0; i < str.length; i++) {
                var char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return Math.abs(hash);
        }

        // Question hash system for uniqueness
        function generateQuestionHash(question, options, correct) {
            var combined = question + JSON.stringify(options) + JSON.stringify(correct);
            return hashString(combined);
        }

        // Enhanced Audio system with iOS compatibility - CONVERTED TO ES5
        function AudioSystem() {
            this.audioContext = null;
            this.enabled = true;
            this.initialized = false;
            this.initAudio();
        }

        AudioSystem.prototype.initAudio = function() {
            try {
                // Use different approach for iOS
                if (IOSUtils.isIOS) {
                    // Delay initialization until user interaction
                    this.audioContext = null;
                } else {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.initialized = true;
                }
            } catch (e) {
                console.log('Audio not supported');
                this.enabled = false;
            }
        };

        AudioSystem.prototype.ensureAudioContext = function() {
            if (!this.audioContext && this.enabled) {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // Resume context if suspended (common on iOS)
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }
                    
                    this.initialized = true;
                } catch (e) {
                    console.log('Audio initialization failed');
                    this.enabled = false;
                }
            }
        };

        AudioSystem.prototype.playTone = function(frequency, duration) {
            duration = duration || 0.2;
            if (!this.enabled) return;
            
            this.ensureAudioContext();
            if (!this.audioContext) return;
            
            try {
                var oscillator = this.audioContext.createOscillator();
                var gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            } catch (e) {
                console.log('Audio playback failed');
            }
        };

        AudioSystem.prototype.playClick = function() {
            this.playTone(800, 0.1);
        };

        AudioSystem.prototype.playCorrect = function() {
            var self = this;
            if (!this.enabled) return;
            setTimeout(function() { self.playTone(523, 0.15); }, 0);
            setTimeout(function() { self.playTone(659, 0.15); }, 100);
            setTimeout(function() { self.playTone(784, 0.15); }, 200);
        };

        AudioSystem.prototype.playIncorrect = function() {
            this.playTone(220, 0.3);
        };

        AudioSystem.prototype.playComplete = function() {
            var self = this;
            if (!this.enabled) return;
            var notes = [523, 587, 659, 698, 784, 880, 988, 1047];
            for (var i = 0; i < notes.length; i++) {
                (function(note, index) {
                    setTimeout(function() {
                        self.playTone(note, 0.2);
                    }, index * 100);
                })(notes[i], i);
            }
        };

        AudioSystem.prototype.toggle = function() {
            this.enabled = !this.enabled;
            return this.enabled;
        };

        // Enhanced Timer for iOS compatibility - CONVERTED TO ES5
        function GameTimer() {
            this.startTime = 0;
            this.intervalId = null;
            this.isRunning = false;
        }

        GameTimer.prototype.start = function(callback) {
            var self = this;
            this.startTime = Date.now();
            this.isRunning = true;
            
            // Use more frequent updates for better accuracy
            var updateInterval = IOSUtils.isIOS ? 100 : 1000;
            
            this.intervalId = setInterval(function() {
                if (self.isRunning && callback) {
                    var elapsed = Math.floor((Date.now() - self.startTime) / 1000);
                    callback(elapsed);
                }
            }, updateInterval);
        };

        GameTimer.prototype.stop = function() {
            this.isRunning = false;
            if (this.intervalId) {
                clearInterval(this.intervalId);
                this.intervalId = null;
            }
            return Math.floor((Date.now() - this.startTime) / 1000);
        };

        GameTimer.prototype.getElapsed = function() {
            return Math.floor((Date.now() - this.startTime) / 1000);
        };

        // Game state - CONVERTED TO ES5
        var currentPlayer = null;
        var currentChallenge = null;
        var currentQuestions = [];
        var currentQuestionIndex = 0;
        var gameScore = 0;
        var correctAnswers = 0;
        var gameTimer = null;
        var seededRandom = null;
        var usedQuestionHashes = new Set();
        
        var audioSystem = new AudioSystem();
        var eventManager = new EventManager();

        // Initialize game
        function initGame() {
            loadProfiles();
            updateSoundButton();
            setupHeaderEvents();
        }

        // Setup header button events
        function setupHeaderEvents() {
            var homeBtn = document.getElementById('homeBtn');
            var soundBtn = document.getElementById('soundBtn');
            
            if (homeBtn) {
                homeBtn.dataset.action = 'goHome';
            }
            
            if (soundBtn) {
                soundBtn.dataset.action = 'toggleSound';
            }
        }

        // Screen navigation
        function showScreen(screenId) {
            var screens = document.querySelectorAll('.screen');
            for (var i = 0; i < screens.length; i++) {
                screens[i].classList.remove('active');
            }
            document.getElementById(screenId).classList.add('active');
        }

        function goHome() {
            showScreen('welcomeScreen');
        }

        function goToIndex() {
            window.location.href = './';
        }

        function toggleSound() {
            var enabled = audioSystem.toggle();
            updateSoundButton();
        }

        function updateSoundButton() {
            var btn = document.getElementById('soundBtn');
            if (btn) {
                btn.textContent = audioSystem.enabled ? 'üîä' : 'üîá';
            }
        }

        // Profile management
        function loadProfiles() {
            var profiles = JSON.parse(localStorage.getItem('mathGameProfiles') || '[]');
            var profilesList = document.getElementById('profilesList');
            
            if (!profilesList) return;
            
            profilesList.innerHTML = '';
            
            for (var i = 0; i < profiles.length; i++) {
                var profile = profiles[i];
                var profileCard = document.createElement('div');
                profileCard.className = 'card profile-card';
                profileCard.dataset.action = 'selectProfile';
                profileCard.dataset.profile = JSON.stringify(profile);
                
                profileCard.innerHTML = 
                    '<button class="profile-delete-btn" data-action="deleteProfile" data-profile-id="' + profile.id + '" data-profile-name="' + profile.name + '" title="Elimina profilo">' +
                        '√ó' +
                    '</button>' +
                    '<div class="profile-card-content">' +
                        '<div class="profile-avatar">' + profile.avatar + '</div>' +
                        '<h3>' + profile.name + '</h3>' +
                        '<p>Migliore: ' + profile.stats.bestScore + ' punti</p>' +
                        '<p>Partite: ' + profile.stats.totalGames + '</p>' +
                    '</div>';
                
                profilesList.appendChild(profileCard);
            }
        }

        function deleteProfile(profileId, profileName) {
            // Confirm deletion
            var confirmDelete = confirm('Sei sicuro di voler eliminare il profilo di ' + profileName + '?\n\nQuesta azione canceller√† tutti i progressi e non pu√≤ essere annullata.');
            
            if (confirmDelete) {
                var profiles = JSON.parse(localStorage.getItem('mathGameProfiles') || '[]');
                
                // Remove profile from array
                var updatedProfiles = [];
                for (var i = 0; i < profiles.length; i++) {
                    if (profiles[i].id != profileId) {
                        updatedProfiles.push(profiles[i]);
                    }
                }
                
                // Update localStorage
                localStorage.setItem('mathGameProfiles', JSON.stringify(updatedProfiles));
                
                // If the deleted profile was currently selected, clear current player
                if (currentPlayer && currentPlayer.id == profileId) {
                    currentPlayer = null;
                }
                
                // Reload profiles list
                loadProfiles();
                
                // Show success message
                setTimeout(function() {
                    alert('Profilo di ' + profileName + ' eliminato con successo!');
                }, 100);
            }
        }

        function selectProfile(profile) {
            currentPlayer = profile;
            showDashboard();
        }

        function selectAvatar(element) {
            var avatarBtns = document.querySelectorAll('.avatar-btn');
            for (var i = 0; i < avatarBtns.length; i++) {
                avatarBtns[i].classList.remove('selected');
            }
            element.classList.add('selected');
        }

        function createProfile() {
            var name = document.getElementById('playerName').value.trim();
            var selectedAvatar = document.querySelector('.avatar-btn.selected');
            
            if (!name) {
                alert('Inserisci un nome!');
                return;
            }
            
            if (!selectedAvatar) {
                alert('Scegli un avatar!');
                return;
            }
            
            var profiles = JSON.parse(localStorage.getItem('mathGameProfiles') || '[]');
            
            var newProfile = {
                id: Date.now(),
                name: name,
                avatar: selectedAvatar.dataset.avatar,
                stats: { totalGames: 0, bestScore: 0 },
                dailyProgress: {}
            };
            
            profiles.push(newProfile);
            localStorage.setItem('mathGameProfiles', JSON.stringify(profiles));
            
            // Update profiles list immediately
            loadProfiles();
            
            currentPlayer = newProfile;
            showDashboard();
        }

        // Setup avatar selection events
        document.addEventListener('DOMContentLoaded', function() {
            var avatarGrid = document.getElementById('avatarGrid');
            if (avatarGrid) {
                avatarGrid.addEventListener('click', function(e) {
                    var avatarBtn = e.target.closest('.avatar-btn');
                    if (avatarBtn) {
                        audioSystem.playClick();
                        selectAvatar(avatarBtn);
                    }
                });
            }
        });

        // Dashboard
        function showDashboard() {
            showScreen('dashboardScreen');
            
            var playerInfo = document.getElementById('playerInfo');
            if (playerInfo) {
                playerInfo.innerHTML = 
                    '<div class="profile-avatar" style="font-size: 4rem;">' + currentPlayer.avatar + '</div>' +
                    '<h2>Ciao, ' + currentPlayer.name + '!</h2>' +
                    '<p>Migliore punteggio: ' + currentPlayer.stats.bestScore + ' punti</p>';
            }
            
            loadChallenges();
        }

        function loadChallenges() {
            var today = IOSUtils.getTodayString();
            var challengesList = document.getElementById('challengesList');
            
            if (!challengesList) return;
            
            challengesList.innerHTML = '';
            
            for (var i = 1; i <= 3; i++) {
                var challengeName = 'Sfida #' + i;
                var isCompleted = currentPlayer.dailyProgress[today] && 
                                   currentPlayer.dailyProgress[today][challengeName];
                
                var challengeCard = document.createElement('div');
                challengeCard.className = 'card challenge-card';
                challengeCard.style.position = 'relative';
                
                var statusClass = isCompleted ? 'status-completed' : 'status-available';
                var statusText = isCompleted ? 'Completata' : 'Disponibile';
                var buttonText = isCompleted ? 'üëÄ Vedi Risultato' : 'üéØ Inizia Sfida';
                
                var completedSection = '';
                if (isCompleted) {
                    completedSection = 
                        '<div style="text-align: center; margin-bottom: 15px;">' +
                            '<strong>Punteggio: ' + isCompleted.score + '</strong><br>' +
                            '<small>Tempo: ' + formatTime(isCompleted.time) + '</small>' +
                        '</div>';
                }
                
                challengeCard.innerHTML = 
                    '<div class="challenge-status ' + statusClass + '">' + statusText + '</div>' +
                    '<h3 style="color: #667eea; margin-bottom: 15px;">' + challengeName + '</h3>' +
                    '<p style="text-align: center; margin-bottom: 15px;">30 domande di matematica</p>' +
                    completedSection +
                    '<button class="btn ' + (isCompleted ? 'btn-primary' : 'btn-success') + '" ' +
                            'data-action="' + (isCompleted ? 'showResults' : 'startChallenge') + '"' +
                            'data-challenge="' + challengeName + '"' +
                            (isCompleted ? 'data-results=\'' + JSON.stringify(isCompleted) + '\'' : '') + '>' +
                        buttonText +
                    '</button>';
                
                challengesList.appendChild(challengeCard);
            }
        }

        // Game logic
        function startChallenge(challengeName) {
            var today = IOSUtils.getTodayString();
            if (currentPlayer.dailyProgress[today] && currentPlayer.dailyProgress[today][challengeName]) {
                alert('Hai gi√† completato questa sfida oggi!');
                return;
            }
            
            currentChallenge = challengeName;
            initializeGame();
            showScreen('gameScreen');
        }

        function initializeGame() {
            // Reset game state
            currentQuestionIndex = 0;
            gameScore = 0;
            correctAnswers = 0;
            usedQuestionHashes.clear();
            
            // Create seeded random generator
            var today = IOSUtils.getTodayString();
            var seed = hashString(currentChallenge + today);
            seededRandom = new SeededRandom(seed);
            
            // Generate questions
            currentQuestions = generateQuestions();
            
            // Start timer
            startGameTimer();
            
            // Load first question
            loadQuestion();
        }

        function generateQuestions() {
            var questions = [];
            
            // Calculate distribution (30 questions total)
            var calcQuestions = 11; // 35%
            var logicQuestions = 7; // 25%
            var problemQuestions = 7; // 25%
            var geometryQuestions = 5; // 15%
            
            // Generate calculation questions
            for (var i = 0; i < calcQuestions; i++) {
                questions.push(generateUniqueQuestion('calculation'));
            }
            
            // Generate logic questions
            for (var i = 0; i < logicQuestions; i++) {
                questions.push(generateUniqueQuestion('logic'));
            }
            
            // Generate problem questions  
            for (var i = 0; i < problemQuestions; i++) {
                questions.push(generateUniqueQuestion('problem'));
            }
            
            // Generate geometry questions
            for (var i = 0; i < geometryQuestions; i++) {
                questions.push(generateUniqueQuestion('geometry'));
            }
            
            // Shuffle all questions using seeded random
            return seededRandom.shuffle(questions);
        }

        function generateUniqueQuestion(type) {
            var question;
            var attempts = 0;
            var maxAttempts = 100;
            
            do {
                switch (type) {
                    case 'calculation':
                        question = generateCalculationQuestion();
                        break;
                    case 'logic':
                        question = generateLogicQuestion();
                        break;
                    case 'problem':
                        question = generateProblemQuestion();
                        break;
                    case 'geometry':
                        question = generateGeometryQuestion();
                        break;
                }
                
                var hash = generateQuestionHash(question.question, question.options, question.correct);
                
                if (!usedQuestionHashes.has(hash)) {
                    usedQuestionHashes.add(hash);
                    return question;
                }
                
                attempts++;
            } while (attempts < maxAttempts);
            
            // If we can't generate a unique question, return the last generated one
            return question;
        }

        function generateCalculationQuestion() {
            var types = ['addition', 'subtraction', 'multiplication', 'division', 'double', 'half'];
            var type = types[seededRandom.int(0, types.length - 1)];
            
            switch (type) {
                case 'addition':
                    var a1, b1, correct1;
                    
                    // Generate addition without carry for numbers with tens
                    var useSimpleAddition = seededRandom.int(0, 1) === 0;
                    
                    if (useSimpleAddition) {
                        // Simple addition with single digits or small numbers
                        a1 = seededRandom.int(1, 20);
                        b1 = seededRandom.int(1, 20);
                    } else {
                        // Addition with tens but no carry
                        a1 = seededRandom.int(10, 80);
                        var a1Tens = Math.floor(a1 / 10);
                        var a1Ones = a1 % 10;
                        
                        var maxB1Tens = Math.floor((99 - a1) / 10);
                        var maxB1Ones = 9 - a1Ones; // Ensure no carry
                        
                        var b1Tens = seededRandom.int(1, Math.max(1, maxB1Tens));
                        var b1Ones = seededRandom.int(0, maxB1Ones);
                        
                        b1 = b1Tens * 10 + b1Ones;
                        
                        // Ensure b1 is at least 1
                        if (b1 === 0) b1 = seededRandom.int(1, 9);
                    }
                    
                    correct1 = a1 + b1;
                    return {
                        question: 'Quanto fa ' + a1 + ' + ' + b1 + '?',
                        correct: correct1,
                        options: generateNumericOptions(correct1)
                    };
                    
                case 'subtraction':
                    // Generate subtraction without borrowing for double digit numbers
                    var larger, smaller, correct2;
                    do {
                        larger = seededRandom.int(20, 99);
                        var largerTens = Math.floor(larger / 10);
                        var largerOnes = larger % 10;
                        
                        // For double digit subtraction, ensure no borrowing needed
                        if (larger >= 20) {
                            var maxSubtrahendTens = largerTens;
                            var maxSubtrahendOnes = largerOnes;
                            
                            var subtrahendTens = seededRandom.int(1, maxSubtrahendTens);
                            var subtrahendOnes = seededRandom.int(0, maxSubtrahendOnes);
                            
                            smaller = subtrahendTens * 10 + subtrahendOnes;
                        } else {
                            smaller = seededRandom.int(1, larger - 1);
                        }
                        
                        correct2 = larger - smaller;
                    } while (smaller >= larger || correct2 <= 0);
                    
                    return {
                        question: 'Quanto fa ' + larger + ' - ' + smaller + '?',
                        correct: correct2,
                        options: generateNumericOptions(correct2)
                    };
                    
                case 'multiplication':
                    var m1 = seededRandom.int(0, 10);
                    var m2 = seededRandom.int(0, 10);
                    var correct3 = m1 * m2;
                    return {
                        question: 'Quanto fa ' + m1 + ' √ó ' + m2 + '?',
                        correct: correct3,
                        options: generateNumericOptions(correct3)
                    };
                    
                case 'division':
                    var divisor = seededRandom.int(1, 10);
                    var quotient = seededRandom.int(1, 10);
                    var dividend = divisor * quotient;
                    return {
                        question: 'Quanto fa ' + dividend + ' √∑ ' + divisor + '?',
                        correct: quotient,
                        options: generateNumericOptions(quotient)
                    };
                    
                case 'double':
                    var num1;
                    var useMultipleOfTen = seededRandom.int(0, 1) === 0;
                    
                    if (useMultipleOfTen) {
                        // Use multiples of 10 up to 50 (10, 20, 30, 40, 50)
                        var multiples = [10, 20, 30, 40, 50];
                        num1 = multiples[seededRandom.int(0, multiples.length - 1)];
                    } else {
                        // Use numbers between 1 and 10
                        num1 = seededRandom.int(1, 10);
                    }
                    
                    var correct4 = num1 * 2;
                    return {
                        question: 'Qual √® il doppio di ' + num1 + '?',
                        correct: correct4,
                        options: generateNumericOptions(correct4)
                    };
                    
                case 'half':
                    var even = seededRandom.int(5, 25) * 2;
                    var correct5 = even / 2;
                    return {
                        question: 'Qual √® la met√† di ' + even + '?',
                        correct: correct5,
                        options: generateNumericOptions(correct5)
                    };
            }
        }

        function generateLogicQuestion() {
            var types = ['sequence', 'comparison', 'pattern', 'advanced_sequence'];
            var type = types[seededRandom.int(0, types.length - 1)];
            
            switch (type) {
                case 'sequence':
                    var start = seededRandom.int(1, 20);
                    var step = seededRandom.int(2, 5);
                    var seq = [start, start + step, start + 2*step, start + 3*step];
                    var next = start + 4*step;
                    return {
                        question: 'Continua la sequenza: ' + seq.join(', ') + ', ?',
                        correct: next,
                        options: generateNumericOptions(next)
                    };
                    
                case 'comparison':
                    var num1 = seededRandom.int(10, 99);
                    var num2 = seededRandom.int(10, 99);
                    var correctAnswer;
                    if (num1 > num2) {
                        correctAnswer = '>';
                    } else if (num1 < num2) {
                        correctAnswer = '<';
                    } else {
                        correctAnswer = '=';
                    }
                    return {
                        question: 'Quale simbolo va messo tra ' + num1 + ' e ' + num2 + '?',
                        correct: correctAnswer,
                        options: seededRandom.shuffle(['<', '>', '=', '‚â†'])
                    };
                    
                case 'pattern':
                    var patterns = [
                        { question: 'Quale numero manca? 2, 4, 6, ?, 10', correct: 8 },
                        { question: 'Quale numero manca? 1, 3, 5, ?, 9', correct: 7 },
                        { question: 'Quale numero manca? 10, 8, 6, ?, 2', correct: 4 },
                        { question: 'Quale numero manca? 5, 10, 15, ?, 25', correct: 20 },
                        { question: 'Quale numero manca? 12, 10, 8, ?, 4', correct: 6 }
                    ];
                    var pattern = patterns[seededRandom.int(0, patterns.length - 1)];
                    return {
                        question: pattern.question,
                        correct: pattern.correct,
                        options: generateNumericOptions(pattern.correct)
                    };
                    
                case 'advanced_sequence':
                    var advancedTypes = ['regressive', 'letters', 'colors'];
                    var advType = advancedTypes[seededRandom.int(0, advancedTypes.length - 1)];
                    
                    switch (advType) {
                        case 'regressive':
                            var regStart = seededRandom.int(50, 100);
                            var regStep = seededRandom.int(3, 8);
                            var regSeq = [regStart, regStart - regStep, regStart - 2*regStep, regStart - 3*regStep];
                            var regNext = regStart - 4*regStep;
                            return {
                                question: 'Continua la sequenza regressiva: ' + regSeq.join(', ') + ', ?',
                                correct: regNext,
                                options: generateNumericOptions(regNext)
                            };
                            
                        case 'letters':
                            var letterSeqs = [
                                { seq: ['A', 'C', 'E', 'G'], next: 'I', question: 'Continua la sequenza: A, C, E, G, ?' },
                                { seq: ['B', 'D', 'F', 'H'], next: 'L', question: 'Continua la sequenza: B, D, F, H, ?' },
                                { seq: ['Z', 'Y', 'X', 'W'], next: 'V', question: 'Continua la sequenza: Z, Y, X, W, ?' }
                            ];
                            var letterSeq = letterSeqs[seededRandom.int(0, letterSeqs.length - 1)];
                            var wrongLetters = ['K', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U'];
                            var letterOptions = [letterSeq.next].concat(seededRandom.shuffle(wrongLetters).slice(0, 3));
                            return {
                                question: letterSeq.question,
                                correct: letterSeq.next,
                                options: seededRandom.shuffle(letterOptions)
                            };
                            
                        case 'colors':
                            var colorSeqs = [
                                { 
                                    pattern: ['üî¥', 'üîµ', 'üî¥', 'üîµ'], 
                                    next: 'üî¥',
                                    question: 'Continua la sequenza di colori: üî¥ üîµ üî¥ üîµ ?'
                                },
                                { 
                                    pattern: ['üü¢', 'üü°', 'üî¥', 'üü¢'], 
                                    next: 'üü°',
                                    question: 'Continua la sequenza di colori: üü¢ üü° üî¥ üü¢ ?'
                                }
                            ];
                            var colorSeq = colorSeqs[seededRandom.int(0, colorSeqs.length - 1)];
                            var allColors = ['üî¥', 'üîµ', 'üü¢', 'üü°', 'üü†', 'üü£'];
                            var filteredColors = [];
                            for (var i = 0; i < allColors.length; i++) {
                                if (allColors[i] !== colorSeq.next) {
                                    filteredColors.push(allColors[i]);
                                }
                            }
                            var colorOptions = [colorSeq.next].concat(seededRandom.shuffle(filteredColors).slice(0, 3));
                            return {
                                question: colorSeq.question,
                                correct: colorSeq.next,
                                options: seededRandom.shuffle(colorOptions)
                            };
                    }
            }
        }

        function generateProblemQuestion() {
            var problemTemplates = [
                {
                    template: "{name} ha {num1} {item}. Ne {action} {num2} {target}. {item_cap} {remaining}?",
                    scenarios: [
                        { name: "Marco", item: "caramelle", item_cap: "Quante caramelle", action: "regala", target: "agli amici", remaining: "gli rimangono" },
                        { name: "Sara", item: "figurine", item_cap: "Quante figurine", action: "scambia", target: "con i compagni", remaining: "le rimangono" },
                        { name: "Luca", item: "matite", item_cap: "Quante matite", action: "perde", target: "a scuola", remaining: "gli rimangono" },
                        { name: "Anna", item: "adesivi", item_cap: "Quanti adesivi", action: "regala", target: "alla sorella", remaining: "le rimangono" }
                    ],
                    operation: "subtraction"
                },
                {
                    template: "In una {place} ci sono {num1} {item1} e {num2} {item2}. Quanti {total_item} ci sono in totale?",
                    scenarios: [
                        { place: "classe", item1: "bambini", item2: "bambine", total_item: "bambini" },
                        { place: "scuola", item1: "maestri", item2: "maestre", total_item: "insegnanti" },
                        { place: "biblioteca", item1: "libri di storie", item2: "libri di scienze", total_item: "libri" },
                        { place: "palestra", item1: "palloni da calcio", item2: "palloni da basket", total_item: "palloni" }
                    ],
                    operation: "addition"
                },
                {
                    template: "{name} ha {num1} {container} con {num2} {item} ciascuna. Quanti {item} ha in totale?",
                    scenarios: [
                        { name: "Sara", container: "scatole", item: "matite" },
                        { name: "Marco", container: "pacchetti", item: "figurine" },
                        { name: "Lisa", container: "bustine", item: "caramelle" },
                        { name: "Paolo", container: "vassoi", item: "biscotti" }
                    ],
                    operation: "multiplication"
                },
                {
                    template: "{name} ha {num1} {item}. Le divide in parti uguali tra {num2} {target}. Quanti {item} riceve ogni {person}?",
                    scenarios: [
                        { name: "Luca", item: "figurine", target: "amici", person: "amico" },
                        { name: "Marta", item: "caramelle", target: "compagni", person: "compagno" },
                        { name: "Giovanni", item: "adesivi", target: "cugini", person: "cugino" },
                        { name: "Elena", item: "matite", target: "amiche", person: "amica" }
                    ],
                    operation: "division"
                },
                {
                    template: "Un {vehicle} trasporta {num1} {people}. Se {action} altri {num2} {people}, quanti {people} ci sono ora?",
                    scenarios: [
                        { vehicle: "autobus", people: "passeggeri", action: "salgono" },
                        { vehicle: "treno", people: "viaggiatori", action: "salgono" },
                        { vehicle: "aereo", people: "passeggeri", action: "salgono" }
                    ],
                    operation: "addition"
                },
                {
                    template: "In un {place} ci sono {num1} {item1} e {num2} {item2}. Quanti {total_item} ci sono in totale?",
                    scenarios: [
                        { place: "parcheggio", item1: "auto rosse", item2: "auto blu", total_item: "auto" },
                        { place: "giardino", item1: "rose rosse", item2: "rose gialle", total_item: "rose" },
                        { place: "negozio", item1: "mele", item2: "pere", total_item: "frutti" },
                        { place: "cortile", item1: "gatti", item2: "cani", total_item: "animali" }
                    ],
                    operation: "addition"
                },
                {
                    template: "Una {food} √® divisa in {num1} {pieces}. Se {name} mangia {num2} {pieces}, quante {pieces} rimangono?",
                    scenarios: [
                        { food: "pizza", pieces: "fette", name: "Marco" },
                        { food: "torta", pieces: "fette", name: "Sara" },
                        { food: "cioccolata", pieces: "quadretti", name: "Luca" }
                    ],
                    operation: "subtraction"
                }
            ];
            
            var template = seededRandom.choice(problemTemplates);
            var scenario = seededRandom.choice(template.scenarios);
            
            var num1, num2, correct;
            
            switch (template.operation) {
                case 'addition':
                    // Generate addition without carry for numbers with tens
                    var useSimpleAddition = seededRandom.int(0, 1) === 0;
                    
                    if (useSimpleAddition) {
                        // Simple addition with single digits
                        num1 = seededRandom.int(5, 20);
                        num2 = seededRandom.int(5, 20);
                    } else {
                        // Addition with tens but no carry
                        num1 = seededRandom.int(10, 70);
                        var num1Tens = Math.floor(num1 / 10);
                        var num1Ones = num1 % 10;
                        
                        var maxNum2Tens = Math.floor((99 - num1) / 10);
                        var maxNum2Ones = 9 - num1Ones; // Ensure no carry
                        
                        var num2Tens = seededRandom.int(1, Math.max(1, maxNum2Tens));
                        var num2Ones = seededRandom.int(0, maxNum2Ones);
                        
                        num2 = num2Tens * 10 + num2Ones;
                        
                        // Ensure num2 is at least 5
                        if (num2 < 5) num2 = seededRandom.int(5, 15);
                    }
                    
                    correct = num1 + num2;
                    break;
                case 'subtraction':
                    num1 = seededRandom.int(20, 80);
                    num2 = seededRandom.int(5, num1 - 5);
                    correct = num1 - num2;
                    break;
                case 'multiplication':
                    num1 = seededRandom.int(2, 8);
                    num2 = seededRandom.int(2, 10);
                    correct = num1 * num2;
                    break;
                case 'division':
                    num2 = seededRandom.int(2, 10);
                    var quotient = seededRandom.int(2, 10);
                    num1 = num2 * quotient;
                    correct = quotient;
                    break;
            }
            
            var question = template.template;
            var keys = Object.keys(scenario);
            for (var i = 0; i < keys.length; i++) {
                var key = keys[i];
                var regex = new RegExp('{' + key + '}', 'g');
                question = question.replace(regex, scenario[key]);
            }
            question = question.replace('{num1}', num1).replace('{num2}', num2);
            
            return {
                question: question,
                correct: correct,
                options: generateNumericOptions(correct)
            };
        }

        function generateGeometryQuestion() {
            var types = ['triangles', 'angles', 'lines', 'polygons', 'line_types', 'line_positions'];
            var type = types[seededRandom.int(0, types.length - 1)];
            
            switch (type) {
                case 'triangles':
                    var triangleQuestions = [
                        { question: 'Come si chiama un triangolo con tutti i lati uguali?', correct: 'Equilatero', options: ['Equilatero', 'Isoscele', 'Scaleno', 'Rettangolo'] },
                        { question: 'Come si chiama un triangolo con due lati uguali?', correct: 'Isoscele', options: ['Equilatero', 'Isoscele', 'Scaleno', 'Rettangolo'] },
                        { question: 'Come si chiama un triangolo con tutti i lati diversi?', correct: 'Scaleno', options: ['Equilatero', 'Isoscele', 'Scaleno', 'Rettangolo'] }
                    ];
                    return triangleQuestions[seededRandom.int(0, triangleQuestions.length - 1)];
                    
                case 'angles':
                    var angleQuestions = [
                        { question: 'Come si chiama un angolo di 90 gradi?', correct: 'Retto', options: ['Retto', 'Acuto', 'Ottuso', 'Piatto'] },
                        { question: 'Come si chiama un angolo minore di 90 gradi?', correct: 'Acuto', options: ['Retto', 'Acuto', 'Ottuso', 'Piatto'] },
                        { question: 'Come si chiama un angolo maggiore di 90 gradi?', correct: 'Ottuso', options: ['Retto', 'Acuto', 'Ottuso', 'Piatto'] },
                        { question: 'Come si chiama un angolo di 180 gradi?', correct: 'Piatto', options: ['Retto', 'Acuto', 'Ottuso', 'Piatto'] }
                    ];
                    return angleQuestions[seededRandom.int(0, angleQuestions.length - 1)];
                    
                case 'lines':
                    var lineQuestions = [
                        { question: 'Come si chiamano due linee che non si incontrano mai?', correct: 'Parallele', options: ['Parallele', 'Perpendicolari', 'Secanti', 'Incidenti'] },
                        { question: 'Come si chiamano due linee che si incontrano ad angolo retto?', correct: 'Perpendicolari', options: ['Parallele', 'Perpendicolari', 'Secanti', 'Incidenti'] }
                    ];
                    return lineQuestions[seededRandom.int(0, lineQuestions.length - 1)];
                    
                case 'polygons':
                    var polygonQuestions = [
                        { question: 'Quanti lati ha un triangolo?', correct: 3, options: [3, 4, 5, 6] },
                        { question: 'Quanti lati ha un quadrato?', correct: 4, options: [3, 4, 5, 6] },
                        { question: 'Quanti lati ha un pentagono?', correct: 5, options: [3, 4, 5, 6] },
                        { question: 'Quanti lati ha un esagono?', correct: 6, options: [3, 4, 5, 6] }
                    ];
                    return polygonQuestions[seededRandom.int(0, polygonQuestions.length - 1)];
                    
                case 'line_types':
                    var lineTypeQuestions = [
                        { question: 'Come si chiama una linea che ha un inizio ma non ha fine?', correct: 'Semiretta', options: ['Retta', 'Segmento', 'Semiretta', 'Spezzata'] },
                        { question: 'Come si chiama una linea che ha un inizio e una fine?', correct: 'Segmento', options: ['Retta', 'Segmento', 'Semiretta', 'Spezzata'] },
                        { question: 'Come si chiama una linea che non ha n√© inizio n√© fine?', correct: 'Retta', options: ['Retta', 'Segmento', 'Semiretta', 'Spezzata'] },
                        { question: 'Come si chiama una linea formata da pi√π segmenti collegati?', correct: 'Spezzata', options: ['Retta', 'Segmento', 'Semiretta', 'Spezzata'] },
                        { question: 'Una linea che forma una curva si chiama:', correct: 'Linea curva', options: ['Linea curva', 'Linea retta', 'Linea spezzata', 'Linea chiusa'] },
                        { question: 'Una linea che torna al punto di partenza si chiama:', correct: 'Linea chiusa', options: ['Linea aperta', 'Linea chiusa', 'Linea curva', 'Linea retta'] }
                    ];
                    return lineTypeQuestions[seededRandom.int(0, lineTypeQuestions.length - 1)];
                    
                case 'line_positions':
                    var positionQuestions = [
                        { question: 'Due rette che si trovano sullo stesso piano e non si incontrano mai sono:', correct: 'Parallele', options: ['Parallele', 'Incidenti', 'Perpendicolari', 'Coincidenti'] },
                        { question: 'Due rette che si incontrano in un punto sono:', correct: 'Incidenti', options: ['Parallele', 'Incidenti', 'Sghembe', 'Coincidenti'] },
                        { question: 'Due rette che coincidono completamente sono:', correct: 'Coincidenti', options: ['Parallele', 'Incidenti', 'Perpendicolari', 'Coincidenti'] }
                    ];
                    return positionQuestions[seededRandom.int(0, positionQuestions.length - 1)];
            }
        }

        function generateNumericOptions(correct) {
            var options = [correct];
            var range = Math.max(10, Math.floor(correct * 0.5));
            
            while (options.length < 4) {
                var option = correct + seededRandom.int(-range, range);
                if (option > 0 && options.indexOf(option) === -1) {
                    options.push(option);
                }
            }
            
            return seededRandom.shuffle(options);
        }

        function loadQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                endGame();
                return;
            }
            
            var question = currentQuestions[currentQuestionIndex];
            
            document.getElementById('questionCounter').textContent = 'Domanda ' + (currentQuestionIndex + 1) + '/30';
            document.getElementById('gameScore').textContent = 'Punti: ' + gameScore;
            document.getElementById('question').textContent = question.question;
            document.getElementById('progressFill').style.width = (((currentQuestionIndex + 1) / 30) * 100) + '%';
            
            var optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';
            
            // Shuffle options using seeded random to ensure consistency
            var shuffledOptions = seededRandom.shuffle(question.options.slice());
            var correctIndex = shuffledOptions.indexOf(question.correct);
            
            for (var i = 0; i < shuffledOptions.length; i++) {
                var option = shuffledOptions[i];
                var button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = option;
                button.dataset.action = 'selectAnswer';
                button.dataset.answer = option;
                button.dataset.correct = (correctIndex === i).toString();
                optionsContainer.appendChild(button);
            }
        }

        function selectAnswer(selectedAnswer, isCorrect) {
            // Disable all option buttons
            var optionBtns = document.querySelectorAll('.option-btn');
            for (var i = 0; i < optionBtns.length; i++) {
                optionBtns[i].disabled = true;
                optionBtns[i].style.pointerEvents = 'none';
            }
            
            // Show correct/incorrect feedback
            var currentQuestion = currentQuestions[currentQuestionIndex];
            var allBtns = document.querySelectorAll('.option-btn');
            for (var i = 0; i < allBtns.length; i++) {
                var btn = allBtns[i];
                if (btn.textContent == currentQuestion.correct) {
                    btn.classList.add('correct');
                } else if (btn.textContent == selectedAnswer && !isCorrect) {
                    btn.classList.add('incorrect');
                }
            }
            
            if (isCorrect) {
                gameScore += 10;
                correctAnswers++;
                audioSystem.playCorrect();
            } else {
                audioSystem.playIncorrect();
            }
            
            // Move to next question after delay
            setTimeout(function() {
                currentQuestionIndex++;
                loadQuestion();
            }, 1500);
        }

        function startGameTimer() {
            gameTimer = new GameTimer();
            gameTimer.start(function(elapsed) {
                document.getElementById('timer').textContent = formatTime(elapsed);
            });
        }

        function formatTime(seconds) {
            var minutes = Math.floor(seconds / 60);
            var remainingSeconds = seconds % 60;
            var minutesStr = minutes.toString();
            var secondsStr = remainingSeconds.toString();
            if (minutesStr.length === 1) minutesStr = '0' + minutesStr;
            if (secondsStr.length === 1) secondsStr = '0' + secondsStr;
            return minutesStr + '\'' + secondsStr + '\'\'';
        }

        function confirmQuit() {
            if (confirm('Sei sicuro di voler abbandonare la sfida? Perderai tutti i progressi!')) {
                if (gameTimer) {
                    gameTimer.stop();
                }
                showScreen('dashboardScreen');
            }
        }

        function endGame() {
            var finalTime = gameTimer ? gameTimer.stop() : 0;
            audioSystem.playComplete();
            
            var accuracy = Math.round((correctAnswers / 30) * 100);
            
            // Determine trophy
            var trophy = 'ü•â';
            if (accuracy >= 90) trophy = 'üèÜ';
            else if (accuracy >= 70) trophy = 'ü•à';
            
            // Save results and update best score immediately
            saveGameResults(gameScore, correctAnswers, finalTime, accuracy);
            
            // Update dashboard immediately to show completion
            updatePlayerStats();
            
            // Update challenges list immediately to show completion
            loadChallenges();
            
            // Show results
            document.getElementById('trophyDisplay').textContent = trophy;
            document.getElementById('finalScore').textContent = gameScore;
            document.getElementById('correctAnswers').textContent = correctAnswers + '/30';
            document.getElementById('finalTime').textContent = formatTime(finalTime);
            document.getElementById('accuracy').textContent = accuracy + '%';
            
            showScreen('resultsScreen');
        }

        function saveGameResults(score, correct, time, accuracy) {
            var today = IOSUtils.getTodayString();
            
            // Update player stats
            if (!currentPlayer.dailyProgress[today]) {
                currentPlayer.dailyProgress[today] = {};
            }
            
            currentPlayer.dailyProgress[today][currentChallenge] = {
                score: score,
                correct: correct,
                time: time,
                accuracy: accuracy
            };
            
            currentPlayer.stats.totalGames++;
            if (score > currentPlayer.stats.bestScore) {
                currentPlayer.stats.bestScore = score;
            }
            
            // Save to localStorage
            var profiles = JSON.parse(localStorage.getItem('mathGameProfiles') || '[]');
            var profileIndex = -1;
            for (var i = 0; i < profiles.length; i++) {
                if (profiles[i].id === currentPlayer.id) {
                    profileIndex = i;
                    break;
                }
            }
            if (profileIndex !== -1) {
                profiles[profileIndex] = currentPlayer;
                localStorage.setItem('mathGameProfiles', JSON.stringify(profiles));
            }
        }

        function updatePlayerStats() {
            var playerInfo = document.getElementById('playerInfo');
            if (playerInfo && currentPlayer) {
                playerInfo.innerHTML = 
                    '<div class="profile-avatar" style="font-size: 4rem;">' + currentPlayer.avatar + '</div>' +
                    '<h2>Ciao, ' + currentPlayer.name + '!</h2>' +
                    '<p>Migliore punteggio: ' + currentPlayer.stats.bestScore + ' punti</p>';
            }
        }

        function showResults(challengeName, results) {
            var accuracy = results.accuracy;
            var trophy = 'ü•â';
            if (accuracy >= 90) trophy = 'üèÜ';
            else if (accuracy >= 70) trophy = 'ü•à';
            
            document.getElementById('trophyDisplay').textContent = trophy;
            document.getElementById('finalScore').textContent = results.score;
            document.getElementById('correctAnswers').textContent = results.correct + '/30';
            document.getElementById('finalTime').textContent = formatTime(results.time);
            document.getElementById('accuracy').textContent = results.accuracy + '%';
            document.getElementById('resultTitle').textContent = challengeName + ' - Risultato';
            
            showScreen('resultsScreen');
        }

        // Initialize game when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Enable audio on first user interaction for iOS
            if (IOSUtils.isIOS) {
                var enableAudioOnFirstTouch = function() {
                    IOSUtils.enableAudio();
                    document.removeEventListener('touchstart', enableAudioOnFirstTouch);
                    document.removeEventListener('click', enableAudioOnFirstTouch);
                };
                
                document.addEventListener('touchstart', enableAudioOnFirstTouch, { once: true });
                document.addEventListener('click', enableAudioOnFirstTouch, { once: true });
            }
            
            initGame();
        });

        // Prevent zoom on double tap for iOS
        if (IOSUtils.isIOS) {
            var lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                var now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // Prevent pinch zoom
            document.addEventListener('gesturestart', function (e) {
                e.preventDefault();
            });
            
            document.addEventListener('gesturechange', function (e) {
                e.preventDefault();
            });
            
            document.addEventListener('gestureend', function (e) {
                e.preventDefault();
            });
        }

        // Handle iOS Safari viewport issues
        if (IOSUtils.isIOS && IOSUtils.isSafari) {
            // Fix viewport height issues on iOS Safari
            var setViewportHeight = function() {
                var vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', vh + 'px');
            };
            
            setViewportHeight();
            window.addEventListener('resize', setViewportHeight);
            window.addEventListener('orientationchange', function() {
                setTimeout(setViewportHeight, 100);
            });
        }

        // Error handling for localStorage
        function safeLocalStorage() {
            try {
                var test = 'test';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                console.warn('localStorage not available');
                return false;
            }
        }

        // Fallback for devices without localStorage
        if (!safeLocalStorage()) {
            // Use sessionStorage or memory storage as fallback
            window.localStorage = {
                getItem: function(key) { return sessionStorage.getItem(key) || null; },
                setItem: function(key, value) { return sessionStorage.setItem(key, value); },
                removeItem: function(key) { return sessionStorage.removeItem(key); }
            };
        }

        // Performance optimization for iOS
        if (IOSUtils.isIOS) {
            // Disable hover effects on iOS to improve performance
            var style = document.createElement('style');
            style.textContent = 
                '@media (hover: none) and (pointer: coarse) {' +
                    '.btn:hover, ' + 
                    '.option-btn:hover, ' + 
                    '.avatar-btn:hover, ' + 
                    '.profile-card:hover,' +
                    '.header-btn:hover {' +
                        'transform: none !important;' +
                        'box-shadow: initial !important;' +
                    '}' +
                '}';
            document.head.appendChild(style);
        }

        // Debug logging for iOS issues
        if (IOSUtils.isIOS && window.location.hostname === 'localhost') {
            console.log('iOS Safari detected - Debug mode');
            console.log('AudioContext support:', !!(window.AudioContext || window.webkitAudioContext));
            console.log('localStorage support:', safeLocalStorage());
            console.log('Touch events support:', 'ontouchstart' in window);
        }
    </script>
</body>
</html>
